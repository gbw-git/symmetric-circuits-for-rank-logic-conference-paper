
\documentclass[a4paper,UKenglish]{lipics-v2018}
% This is a template for producing LIPIcs articles. See lipics-manual.pdf for
% further information. for A4 paper format use option "a4paper", for US-letter
% use option "letterpaper" for british hyphenation rules use option "UKenglish",
% for american hyphenation rules use option "USenglish" for section-numbered
% lemmas etc., use "numberwithinsect"

%\usepackage{microtype}%if unwanted, comment out or use option "draft"


\usepackage{xspace}
\usepackage{mymacros}
\usepackage{tikz-cd}

% 
\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}% the recommnded bibstyle

\title{Symmetric Circuits for Rank Logic}

% \titlerunning{Dummy short
% title}%optional, please use if title is longer than one line

\author{Anuj Dawar}{Department of Computer Science and Technology,
  University of Cambridge}{anuj.dawar@cl.cam.ac.uk}{0000-0003-4014-8248}{}%mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty.

\author{Gregory Wilsenach}{Department of Computer Science and
  Technology, University of Cambridge}{gregory.wilsenach@cl.cam.ac.uk}{}{Funding
  provided by the Gates Cambridge Scholarship}

\authorrunning{A. Dawar and G. Wilsenach} %mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et. al.'

\Copyright{Anuj Dawar and Gregory
  Wilsenach} %mandatory, please use full first names. LIPIcs license is "CC-BY"; http://creativecommons.org/licenses/by/3.0/

\subjclass{F.1.3 Complexity Measures and Classes, F.4.1 Math.
  Logic} % mandatory: Please choose ACM 2012 classifications from https://www.acm.org/publications/class-2012 or https://dl.acm.org/ccs/ccs_flat.cfm . E.g., cite as "General and reference $\rightarrow$ General literature" or \ccsdesc[100]{General and reference~General literature}.

\keywords{fixed-point logic with rank,
circuits,
symmetric circuits,
uniform families of circuits,
circuit characterization,
circuit framework,
finite model theory,
descriptive complexity}%mandatory

\category{}%optional, e.g. invited paper

\relatedversion{}%optional, e.g. full version hosted on arXiv, HAL, or other respository/website

\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...

\funding{}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

%\acknowledgements{I want to thank \dots}%optional

% Editor-only macros:: begin (do not touch as
% author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access} \EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016} \EventAcronym{CVIT} \EventYear{2016}
\EventDate{December 24--27, 2016} \EventLocation{Little Whinging, United
  Kingdom} \EventLogo{} \SeriesVolume{42} \ArticleNo{23}
% \nolinenumbers %uncomment to disable line numbering
% \hideLIPIcs %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

\begin{abstract}
  Fixed-point logic with rank (FPR) is an extension of fixed-point logic with
  counting (FPC) with operators for computing the rank of a matrix over a finite
  field. The expressive power of FPR properly extends that of FPC and is
  contained in PTime, but not known to be properly contained. We give a circuit
  characterization for FPR in terms of families of symmetric circuits with rank
  gates, along the lines of that for FPC given by [Anderson and Dawar 2017].
  This requires the development of a broad framework of circuits in which the
  individual gates compute functions that are not symmetric (i.e., invariant
  under all permutations of their inputs). This framework also
  necessitates the development of novel techniques to prove the
  equivalence of circuits and logic.  Both the framework and the
  techniques are of greater generality than the main result.
\end{abstract}

\section{Introduction}\label{sec:introduction}

The study of extensions of fixed-point logics plays an important role in the
field of descriptive complexity theory. In particular, fixed-point logic with
counting ($\FPC$) has become a reference logic in the search for a logic for
polynomial-time (see~\cite{Dawar-siglog}). In this context, Anderson and
Dawar~\cite{AndersonD17} provide an interesting characterisation of the
expressive power of $\FPC$ in terms of circuit complexity. They show that the
properties expressible in this logic are exactly those that can be decided by
polynomially-uniform families of circuits (with threshold gates) satisfying a
natural \emph{symmetry} condition. Not only does this illustrate the robustness
of $\FPC$ as a complexity class within $\PT$ by giving a distinct and natural
characterization of it, it also demonstrates that the techniques for proving
inexpressibility in the field of finite model theory can be understood as
lower-bound methods against a natural circuit complexity class. This raises an
obvious question (explicitly posed in the concluding section
of~\cite{AndersonD17}) of how to obtain circuit characterizations of logics more
expressive than $\FPC$, such as choiceless polynomial time (CPT) and fixed-point
logic with rank ($\FPR$). It is this last question that we address in this
paper.

Fixed-point logic with rank extends the expressive power of $\FPC$ by means of
operators that allow us to define the rank of a matrix over a finite field. Such
operators are natural extensions of counting---counting the dimension of a
definable vector space rather than just the size of a definable set. At the same
time they make the logic rich enough to express many of the known examples that
separate $\FPC$ from $\PT$. Rank logics were first introduced
in~\cite{Dawar09logicswith}. The version $\FPR$ we consider here is that defined
by Gr\"adel and Pakusa~\cite{GradelP15a} where the prime characteristic is a
parameter to the rank operator, and we do not have a distinct operator for each
prime number. Formal definitions of these logics are given in
Section~\ref{sec:background}. We give a circuit characterization, in terms of
symmetric circuits, of $\FPR$. One might think, at first sight, that this is a
simple matter of extending the circuit model with gates for computing the rank
of a matrix. It turns out, however, that the matter is not so simple as the
symmetry requirement interacts in surprising ways with such rank gates. It
requires a new framework for defining classes of such circuits, which yields
remarkable new insights.

The word \emph{symmetry} is used in more than one sense the context of circuits
(and also in this paper). We say that a Boolean function $f:\{0,1\}^n \ra
\{0,1\}$ is symmetric if the value of the function on a string $s$ is determined
by the number of $1$s in $s$. In other words, $f$ is invariant under \emph{all}
permutations of its input. In contrast, when we consider the input to a Boolean
function to be the adjacency matrix of an $n$-vertex graph, for example, and $f
: \{0,1\}^{n \choose 2} \ra \{0,1\}$ decides a graph property, then $f$ is
invariant under all permutations of its input induced by permutations of the $n$
vertices of the graph. We call such a function \emph{graph-invariant}. More
generally, for a relational vocabulary $\tau$ and a standard encoding of
$n$-element $\tau$-structures as strings over $\{0,1\}$, we can say that
function taking such strings as input is $\tau$-invariant if it is invariant
under permutations induced by the $n$ elements. A circuit $C$ computing such an
invariant function is said to be \emph{symmetric} if every permutation of the
$n$ elements extends to an automorphism of $C$. It is families of symmetric
circuits in this sense that characterize $\FPC$ in~\cite{AndersonD17}. The
restriction to symmetric circuits arises naturally in the study of logics and
has appeared previously under the names of generic circuits in the work
of~\cite{DENENBERG1986216} and explicitly order-invariant circuits in the work
of Otto~\cite{Otto1997}. In this paper, we use the word ``symmetric'', and
context is used to distinguish the meaning of the word as applied to circuits
from its meaning as applied to Boolean functions.

The main result of~\cite{AndersonD17} says that the properties of
$\tau$-structures definable in $\FPC$ are exactly those that can be decided by
$\PT$-uniform families of symmetric circuits using AND, OR, NOT and majority
gates. Note that each of these gates itself computes a Boolean function that is
symmetric in the strong sense identified above. On the other hand, a gate for
computing a rank threshold function, e.g.\ one that takes as input a $n \times
n$ matrix and outputs $1$ if the rank of the matrix is greater than a threshold
$t$, is \emph{not} symmetric. In our circuit characterization of $\FPR$ we
necessarily have to consider such non-symmetric gates. Indeed, we can show that
$\PT$-uniform families of symmetric circuits using gates for \emph{any}
symmetric functions do not take us beyond the power of $\FPC$. This is a further
illustration of the robustness of $\FPC$. In order to go beyond it, we need to
introduce gates for Boolean functions that are not symmetric. We construct a
systematic framework for including functions computing $\tau$-invariant
functions for arbitrary multi-sorted relational vocabularies $\tau$ in
Section~\ref{sec:symm-circ}. We also explore what it means for such circuits to
be symmetric.

The proof of the circuit characterization of $\FPC$ relies on the \emph{support
  theorem} proved in~\cite{AndersonD17}. This establishes that for any
$\PT$-uniform family of circuits using $\AND$, $\OR$, $\NOT$ and majority gates
there is a constant $k$ such that every gate has a support of size at most $k$.
That is to say that we can associate with every gate $g$ in the circuit $C_n$
(the circuit in the family that works on $n$-element structures) a subset $X$ of
$[n]$ of size at most $k$ such that any permutation of $[n]$ fixing $X$
pointwise extends to an automorphism of $C_n$ that fixes $g$. This theorem is
crucial to the translation of the family of circuits into a formula of $\FPC$,
which is the difficult (and novel) direction of the equivalence. In attempting
to do the same with circuits that now use rank-threshold gates we are faced with
the difficulty that the proof of the support theorem in~\cite{AndersonD17}
relies in an essential way on the fact that the Boolean function computed at
each gate is symmetric. We are able to overcome this difficulty and prove a
support theorem for circuits with rank gates but this requires substantial,
novel technical machinery.

Another crucial ingredient in the proof of Anderson and Dawar is that we can
eliminate redundancy in the circuit $C_n$ by making it \emph{rigid}. That is, we
can ensure that the \emph{only} automorphisms of $C_n$ are those that are
induced by permutations of $[n]$. Here we face the difficulty that identifying
the symmetries and eliminating redundancy in a circuit that involves gates
computing $\tau$-invariant functions requires us to solve the isomorphism
problem for $\tau$-structures. This is a hard problem (or, at least, one that we
do not know how to solve efficiently) even when the $\tau$-structures are
$0$-$1$-matrices. We overcome this difficulty by placing a further restriction
on circuits that we call \emph{transparency}. Circuits satisfying this condition
have the property that their lack of redundancy is transparent.

In the characterization of $\FPC$, the translation from formulas into families
of circuits is easy and, indeed, standard. In our case, we have to show that
formulas of $\FPR$ translate into uniform families of circuits using
rank-threshold gates that are symmetric and transparent. This is somewhat more
involved technically and presented in Section~\ref{sec:formulas-to-circuits}.
Finally, with all these tools in place, the translation of such $\PT$-uniform
families of circuits into formulas of $\FPR$ given in
Section~\ref{sec:circuits-to-formulas} completes the characterization. This
still requires substantial new techniques. The translation of circuits to
formulas in~\cite{AndersonD17} relies on the fact that in order to evaluate a
gate computing a symmetric Boolean function, it suffices to count the number of
inputs that evaluate to true and there is a bijection between the orbits of a
gate and tuple assignments to its support. When counting is no longer
sufficient, this bijection has to preserve more structure and demonstrating this
in the case of matrices requires new insight.

Space limitations prevent us from giving details of proofs. These and much more
detail can be found in the full version of this paper~\cite{DW-arxiv}.


\section{Background}\label{sec:background}
Let $\sym_S$ denote the group of all permutations of the set $S$. We write
$\sym_n$ for $\sym_{[n]}$. We let $A^{\underline{B}}$ denote the set of
injections from the set $B$ to the set $A$.

\subsection{Logic}
A \emph{vocabulary} is a finite sequence of relation symbols $(R_1, \ldots,
R_k)$, each of which has a fixed \emph{arity}. We often let $r_i \in \nats$
denote the arity of the relation symbol $R_i$. A \emph{many-sorted vocabulary}
is a tuple of the form $(R, S, \nu)$, where $R$ is a relational vocabulary, $S$
is a finite sequence of \emph{sort} symbols, and $\nu$ is a function that
assigns to each $R_i \in R$ a tuple $\nu(R_i) := (s_1, \ldots, s_{r_i})$, where
for each $j \in [r_i]$, $s_j \in S$. We call $\nu(R_i)$ the \emph{type} of
$R_i$. A \emph{$\tau$-structure} $\mathcal{A}$ is a tuple $(U ,
R^{\mathcal{A}}_1 , \ldots , R^{\mathcal{A}}_k)$ where $U = \uplus_{s \in S }
U_{s}$ a disjoint union of non-empty sets, is called the \emph{universe} of
$\mathcal{A}$, and for all $i \in [k]$, $R^{\mathcal{A}}_i \subseteq U_{s_1} \times \ldots \times U_{s_{r_i}}$, where
$(s_1 , \ldots , s_{r_i}) = \nu (R_i)$. The size of $\mathcal{A}$, denoted by
$\vert \mathcal{A} \vert$ is the cardinality of its universe. All structures in
this paper are finite.

% Let $\FO[\tau]$ denote \emph{first-order logic} with respect to the vocabulary
% $\tau$. A formula in $\FO[\tau]$ is formed from atomic formulas, each formed
% using variables from some countable sequence of (first-order) variable symbols
% $(x, y, \ldots)$, the relation symbols in $\tau$, and the equality symbol $=$,
% and then closing the set of atomic formulas under the Boolean connectives,
% negation, and universal and existential quantification (i.e.\ $\land$, $\lor$,
% $\neg$, $\forall$, and $\exists$).

We assume the reader is familiar with first-order logic $\FO$, inflationary
fixed-point logic ($\FP$), fixed-point logic with counting ($\FPC$), and
first-order logic with counting quantifiers ($\FOC$). For details on these
logics please see \cite{grohe2017descriptive, immerman1999descriptive}.

\subsection{Rank Logic}
Let $\FPR[\tau]$ denote \emph{fixed-point logic with rank} over the
vocabulary $\tau$. $\FPR$ extends $\FP$ with an operator that denotes the rank
of a definable matrix over a finite field, as well as other mechanisms for
reasoning about quantity. Each variable in a formula of $\FPR$ is either a
\emph{number variable} or \emph{vertex variable}, with vertex
variables interpreted by elements of the universe and number variables
interpreted by natural numbers.
All atomic formulas in $\FP[\tau]$ are atomic formulas in $\FPR[\tau]$. We say
that $t$ is a \emph{number term} if $t$ is a number variable or if $t$ is an
application of the \emph{rank operator}, i.e.\ $t = [\rank (\vec{x}, \vec {\nu}
\leq \vec{t}, \vec{y},\vec{\mu} \leq \vec{s}, \pi \leq \eta). \phi]$, where
$\phi$ is a number term or formula, $\vec{t}$ and $\vec{s}$ are tuples of number
terms bounding the sequences of number variables $\vec{\mu}$ and $\vec{\nu}$,
and $\eta$ is a number term bounding the number variable $\pi$. If $t_1$ and
$t_2$ are number terms then $t_1 \leq t_2$ and $t_1 = t_2$ are atomic formulas.
The formulas of $\FPR$ are formed by closing the set of atomic formulas under
the usual Boolean connectives, the first-order quantifiers, and the fixed-point
operator. When quantifying over number variables we only allow bounded
quantification. Second-order variables, such as those that appear in a
fixed-point application, may have mixed-type.

% There are actually two rank logics defined in the literature. The logic we have
% just introduced, $\FPR$, was defined by Grad{\"e}l and Pakusa~\cite{GradelP15a}.
% $\FPR$ is strictly more expressive than the alternative rank logic introduced
% in~\cite{Dawar09logicswith}.
Let $\FOR[\tau]$ be the set of formulas in
$\FPR[\tau]$ without an application of the fixed-point operator. Let
$\FOrk[\tau]$ be defined as follows. We define for each prime $p$, and natural
number $r$, a rank quantifier $\rank^r_p$, such that $\rank^r_p\vec{x}\vec{y}.
\phi$ is interpreted as $[\rank (\vec{x}, \vec{y}, \pi) . \phi] \geq t_r$, where
$\pi$ is assigned to $p$ and $t_r$ is a number term that evaluates to $r$. Let
$\mathcal{R}$ be the set of all such quantifiers and $\FOrk[\tau]$ be the
closure of $\FO[\tau]$ under $\mathcal{R}$. For more details on rank quantifiers
see~\cite{Dawar09logicswith}.


\section{Generalising Symmetric Circuits}\label{sec:symm-circ}
A \emph{Boolean basis} is a set of Boolean functions. We always use $\BB$ to
denote a basis. Let $\BS$ denote the \emph{standard basis} containing the
Boolean functions computing $\AND$, $\OR$ and $\NOT$ for each arity. Let $\BM$
denote the \emph{majority basis} extending the $\BS$ with the functions
computing majority for each arity.

A Boolean circuit $C$ is a directed acyclic graph in which each internal gate
$g$ is labelled with a function $f_g : \{0,1\}^q \ra \{0,1\}$ from a basis $\BB$
where $q$ is the fan-in of $g$. However, if $f_g$ were allowed to be arbitrary
then an order would need to be imposed on the children of $g$ in order to ensure
unambiguous evaluation. As such, the usual notion of a circuit as a directed
acyclic graph with no structure on the children of any gate $g$ implicitly
assumes that $f_g$ is invariant under all permutations of its inputs---i.e.\
$f_g$ is a symmetric function. Indeed, it is easy to see that the standard basis
and majority basis only contain symmetric functions.

Anderson and Dawar's~\cite{AndersonD17} characterisation of $\FPC$ is in terms
of symmetric circuits over the majority basis. This circuit model cannot be
strengthened by extending the basis by symmetric functions
(see~\cite{DW-arxiv}). As our ultimate aim is a circuit characterisation of
$\FPR$, which is strictly more expressive than than $\FPC$, we would like to
consider circuits defined over bases containing non-symmetric Boolean functions.
In particular, we are interested in bases containing rank-threshold functions --
i.e.\ functions that take in a matrix and decide if the matrix understood as
having entries in some prime field has rank less than some threshold. While
these functions are not symmetric in the full sense, they are symmetric in the
sense of being invariant under row-column permutations.

To lead up to this we first develop a general framework of structured Boolean
functions. These are functions whose inputs naturally encode $\tau$-structures,
rather than just matrices or strings, and where the output is invariant under
the natural symmetries of such structures. We therefore define symmetric
circuits in a general form where gates can be labelled by
\emph{isomorphism-invariant} structured functions.

\subsection{Structured Functions}
Let $X$ be a finite set and $F: \{0,1\}^X \rightarrow \{0,1\}$. It is often the
case that we are interested in Boolean functions that take in strings, and in
this case we would have $X = [n]$ for some $n \in \nats$. The natural notion of
symmetry for such functions is invariance under arbitrary permutations of $X$,
i.e.\ the usual notion of a symmetric function. However, in some cases we are
interested in Boolean functions that take structures as input. For example, if
we are interested in Boolean functions that that as inputs directed graphs we
would let $X = V^2$ for some vertex set $V$. In this case the natural symmetry
condition would not be invariance under arbitrary permutation, but rather
invariance under the action of a permutation of $V$.

In this section we introduce functions that take $\tau$-structures as input,
where $\tau$ is some many-sorted vocabulary. Let $\tau := (R, S, \nu)$ be a
many-sorted vocabulary and let $D := \biguplus_{s \in S} D_{s} = \{(s,d) : d \in
D_s\}$, be a disjoint union of non-empty sets. Let $\str{\tau, D}$ be the
$\tau$-structure with universe $D$ and such that every relation is full. We let
$\ind (\tau, D)$ be the set $\biguplus_{R_i\in R} R^{D}_i := \{ (\vec{a}, R) :
\vec{a} \in R^{D}, \, R \in \tau \} $. We call $\ind(\tau, D)$ the \emph{index
  defined by $(\tau, D)$}.

The idea is that $\ind(\tau, D)$ contains all of the potential elements of a
relation in a $\tau$-structure or, equivalently, the collection of ground atoms
in the vocabulary $\tau$ with elements from the domain $D$. We call $F :
\{0,1\}^{\ind(\tau, D)} \ra \{0,1\}$ a \emph{$(\tau, D)$-structured function},
or just \emph{structured function}, and we call $\tau$ and $D$ the
\emph{vocabulary} and \emph{universe} of $F$. We call $\ind(\tau, D)$ the
\emph{index} of $F$, and denote it by $\ind(F)$. Thus, an element of
$\{0,1\}^{\ind(\tau, D)}$ is a particular $\tau$-structure on domain $D$ and $F$
is a function that determines some property of such structures. We are
especially interested in isomorphism-invariant properties and identify these
next.

Let $H$ be a set. We think of a function $f : \ind(\tau, D) \rightarrow H$ as
defining a labelling of $\str{\tau,D}$ by $H$, and we identify $f$ with this
labelled instance of $\str{\tau, D}$. Let $f: \ind(\tau, D) \ra H$ and $g : \ind
(\tau, D') \ra H$. We say that $f$ and $g$ are \emph{isomorphic} if there is an
isomorphism $\pi : \str{\tau, D} \ra \str{\tau, D'}$ such that $f(\vec{a}_R) =
g(\pi(\vec{a}_R))$ for all $\vec{a}_R \in \ind(\tau, D)$. In other words, $f$
and $g$ are isomorphic if, and only if, they are isomorphic as (labelled)
structures. Notice that if $H = \{0,1\}$ then $f$ and $g$ define
$\tau$-structures and $f$ and $g$ are isomorphic if, and only if, the
$\tau$-structures they define are isomorphic.

We say that $F : \{0,1\}^{\ind(\tau,D)} \ra \{0,1\}$ is
\emph{isomorphism-invariant} if for all $f, g : \ind(\tau, D) \ra \{0,1\}$
whenever $f$ and $g$ are isomorphic then $F(f) = F(g)$.

\subsection{Symmetric Circuits}
We now generalise the circuit model in~\cite{AndersonD17} in order to allow for
circuits to be defined over bases that include non-symmetric (structured)
functions. In this model each gate $g$ is not only associated with an element of
the basis, but also with a labelling function. This labelling function maps the
input gates of $g$ to an appropriate set of labels (i.e. the index of the
structured function associated with $g$). In concord with this generalisation,
we also update the circuit-related notions from~\cite{AndersonD17}, e.g.\
circuit automorphisms, symmetry, etc. Moreover, we briefly discuss some of the
important complications introduced by our generalisation, and introduce some of
the important tools we use to address these complications.

\begin{definition}[Circuits on Structures]
  Let $\mathbb{B}$ be a basis of structured functions and $\rho$ be a relational
  vocabulary, we define a \emph{$(\mathbb{B}, \rho)$-circuit} $C$ of order $n$
  computing a $q$-ary query $Q$ as a structure $\langle G, \Omega, \Sigma,
  \Lambda, L \rangle$.
  \begin{itemize}
    \setlength\itemsep{0mm}
  \item $G$ is called the set of gates of
    $C$.% and $\vert C \vert := \vert G \vert$.
  \item $\Omega$ is an injective function from $[n]^q$ to $G$. The gates in the
    image of $\Omega$ are called the output gates. When $q = 0$, $\Omega$ is a
    constant function mapping to a single output gate.
  \item $\Sigma$ is a function from $G$ to $\mathbb{B} \uplus \rho \uplus
    \{0,1\} $ such that $\vert \Sigma^{-1} (0) \vert \leq 1$ and $\vert
    \Sigma^{-1} (1) \vert \leq 1$. Those gates mapped to $\rho \uplus \{0,1\}$
    are called input gates, with those mapped to $\rho$ called relational gates
    and those mapped to $\{0,1\}$ called constant gates. Those gates mapped to
    $\mathbb{B}$ are called internal gates.
  \item $\Lambda$ is a sequence of injective functions $(\Lambda_{R_i})_{R_i \in
      R}$ such that $\Lambda_{R_i}$ maps each relational gate $g$ with $\Sigma
    (g) = R_i$ to the tuple $\Lambda_{R_i} (g) \in [n]^{r}$. When no ambiguity
    arises we write $\Lambda (g)$ for $\Lambda_{R_i} (g)$.
  \item $L$ associates with each internal gate $g$ a function $L(g):
    \ind(\Sigma(g)) \rightarrow G$ such that if we define a relation $W
    \subseteq G^{2}$ by $W(h_1,h_2)$ iff $h_2$ is an internal gate and $h_1$ is
    in the image of $L(h_2)$, then $(G, W)$ is a directed acyclic graph.
  \end{itemize}
\end{definition}

The definition requires some explanation. Each gate in $G$ computes a function
of its inputs and the relation $W$ on $G$ is the set of ``wires''. That is,
$W(h,g)$ indicates that the value computed at $h$ is an input to $g$. However,
since the functions are structured, we need more information on the set of
inputs to $g$ and this is provided by the labelling $L$. $\Sigma(g)$ tells us
what the function computed at $g$ is, and thus $\ind(\Sigma(g))$ tells us the
structure on the inputs and $L(g)$ maps this to the set of gates that form the
inputs to $g$. We let $H_g = \{h \in G : W(h,g)\}$ denote the set of inputs to
the gate $g$. We let $\universe{g}$ denote the universe of $\Sigma(g)$. We call
a gate $g$ a \emph{symmetric gate} if $\Sigma(g)$ is a symmetric function and
$g$ a \emph{non-symmetric gate} otherwise.

Let $\rho$ be a relational vocabulary, $\mathcal{A}$ be a $\rho$-structure with
universe $U$ of size $n$, and $\gamma \in [n]^{\underline{U}}$. Let $\gamma
\mathcal{A}$ be the structure with universe $[n]$ formed by mapping the elements
of $U$ in accordance with $\gamma$. The evaluation of a $(\mathbb{B},
\rho)$-circuit $C$ of order $n$ computing a $q$-ary query $Q$ proceeds by
recursively evaluating the gates in the circuit. The evaluation of the gate $g$
for the bijection $\gamma$ and input structure $\mathcal{A}$ is denoted by
$C[\gamma \mathcal{A}](g)$, and is given as follows:

\begin{itemize}
\item if $g$ is a constant gate then it evaluates to the bit given by
  $\Sigma(g)$,
\item if $g$ is a relational gate then $g$ evaluates to true iff $\gamma
  \mathcal{A} \models \Sigma(g)(\Lambda (g))$, and
\item if $g$ is an internal gate such that $\Sigma (g)$ let $L^{\gamma
    \mathcal{A}}(g): \ind(g) \rightarrow \{0,1\}$ be defined by
  $L^{\gamma\mathcal{A}}(g)(x) = C[\gamma \mathcal{A}](L(g)(x))$, for all $x \in
  \ind(g)$. Then $g$ evaluates to true if, and only if, $\Sigma(g)
  (L^{\gamma}_g) = 1$.
\end{itemize}

We say that $C$ defines the $q$-ary query $Q \subseteq U^q$ under $\gamma$ where
$\vec{a} \in Q$ if, and only if, $C[\gamma \mathcal{A}](\Omega (\gamma \vec{a}))
= 1$.

We now define a circuit automorphism for a circuit.

\begin{definition}[Automorphism]\label{defn:automorphism}
  Let $C = \langle G, \Omega, \Sigma, \Lambda, L\rangle$ be a
  $(\mathbb{B},\tau)$-circuit of order $n$ computing a $q$-ary query, and where
  $\mathbb{B}$ is a basis of isomorphism-invariant structured functions. Let
  $\sigma \in \sym_n$ and $\pi: G \rightarrow G$ be a bijection such that
  \begin{itemize}
  \item for all output tuples $x \in [n]^q$, $\pi \Omega (x) = \Omega (\sigma
    x)$,
  \item for all gates $g \in G$, $\Sigma (g) = \Sigma (\pi g)$,
  \item for each relational gate $g \in G$, $\sigma \Lambda (g) = \Lambda (\pi
    g)$, and
  \item For each pair of gates $g, h \in G$ $W(h,g)$ if and only if $W(\pi h,
    \pi g)$ and for each internal gate $g$ we have that $L(\pi g)$ and $ \pi
    \cdot L(g)$ are isomorphic.
  \end{itemize}
  We call $\pi$ an \emph{automorphism} of $C$, and we say that $\sigma$
  \emph{extends to an automorphism} $\pi$. The group of automorphisms of $C$ is
  called $\aut (C)$.
\end{definition}

We are particularly interested in circuits that have the property that
\emph{every} permutation in $\sym_n$ extends to an automorphism of the circuit.

\begin{definition}[Symmetry]
  A circuit $C$ on structures of size $n$ is called \emph{symmetric} if every
  $\sigma \in \sym_n$ extends to an automorphism on $C$.
\end{definition}

It follows that for any symmetric circuit $C$ of order $n$ there is a
homomorphism $h$ that maps $\sym_n$ to $\aut(C)$ such that if $\sigma \in
\sym_n$ then $h(\sigma)$ is an an automorphism extending $\sigma$. Suppose $C$
does not contain a relational gate labelled by a relation symbol with non-zero
arity. In that case $C$ computes a constant function. For this reason, we always
assume a circuit contains at least one relational gate with non-zero arity. Now,
by assumption there exists a relational gate in $C$ such that some element of
$[n]$ appears in the tuple labelling that gate. By symmetry it follows that
every element of $[n]$ appears in a tuple labelling a relational gate in $C$. It
follows that no two distinct elements of $\sym_n$ agree on all input gates, and
so the homomorphism $h$ is injective. If $h$ is also surjective then we have
that each element of $\sigma$ extends uniquely to an automorphism of the
circuit. In this case we say that a circuit has \emph{unique extensions}.

\begin{definition}
  We say that a circuit $C$ has \emph{unique extensions} if for every $\sigma
  \in \sym_n$ there is at most one $\pi_{\sigma} \in \aut(C)$ such that
  $\pi_{\sigma}$ extends $\sigma$.
\end{definition}

Many important technical tools, e.g.\ the support theorem, are only applicable
to circuits with unique extensions. It is for this reason that a notion of a
\emph{rigid} circuit is introduced in~\cite{AndersonD17}. Such circuits have
unique extensions and it is shown that a symmetric circuit over the basis $\BM$
can be converted in polynomial-time to an equivalent rigid one.

We should like to develop a property analogous to rigidity for our framework as
well as a similar polynomial-time translation. However, in our framework the
value a gate $g$ computes is a function not just on the \emph{set} of children
but depends on the structure on its input gates. This structure must be
preserved by the action of an automorphism, and so we require that if $\pi$ is
an automorphism that maps $g$ to $g'$ then $\pi L(g)$ and $L(g')$ are
isomorphic. Following from this observation, it can be shown that deciding if a
function on the circuit is an automorphism, and indeed deciding almost any
symmetry-related property, for circuits with non-symmetric gates is at least as
hard as the graph-isomorphism problem. As such, constructing an argument
analogous to~\cite{AndersonD17}, as well as establishing the numerous other
crucial results whose proofs rely on the polynomial-time decidability of various
circuit properties, would be beyond the scope of this paper.

In order to proceed we explicitly restrict our attention to a \emph{transparent}
circuits. We will define this term below, but before we do we need to define a
notion of `structural similarity' between gates that we call
\emph{syntactic-equivalence}.

\begin{definition}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\mathbb{B},
  \rho)$-circuit of order $n$. We recursively define the equivalence relation
  \emph{syntactic-equivalence}, which we denote using the symbol `$\equiv$', on
  $G$ as follows. Suppose $g$ and $h$ are gates in $C$ such that $\Sigma (g) =
  \Sigma(h)$ and either both $g$ and $h$ are output gates and $\Omega^{-1}(g) =
  \Omega^{-1}(h)$ or neither are output gates. Suppose $g$ and $h$ are input
  gates, then $g \equiv h$ if, and only if, both $g$ and $h$ are constant gates
  or both are relational gates and $\Lambda(g) = \Lambda (h)$. Suppose $g$ and
  $h$ are internal gates and suppose we have defined the syntactic-equivalence
  relation for all gates of depth less than the depth of either $g$ or $h$. Then
  $g \equiv h$ if, and only if, $L(g) /_\equiv$ and $L(h) /_\equiv$ are
  isomorphic.
\end{definition}

The intuition is that two gates are syntactically-equivalent if the circuits
underneath these two gates are structurally equivalent. The important point is
that if two gates are mapped to one another by an automorphism that extends the
trivial permutation, then these gates are syntactically-equivalent. In fact, we
can prove a slightly stronger result.

\begin{lemma}
  let $C$ be a circuit of order $n$, $\sigma \in \sym_n$. Let $\pi, \pi' \in
  \aut(C)$ extend $\sigma$. For every $g$ in $C$ we have $\pi (g) \equiv \pi'
  (g)$.
  \label{lem:permutation-extending-syntactic-equivalence}
\end{lemma}

In this way syntactic-equivalence constrains the automorphism group. We use
syntactic-equivalence to establish sufficient conditions for a circuit to have
unique extensions and, moreover, for various circuit-properties that reference
automorphism to be polynomial-time decidable. With these two ideas in mind we
define the following classes of circuits.

\begin{definition}
  Let $C$ be a circuit and $g$ be a gate in $C$. We say $g$ has \emph{injective
    labels} if $L(g)$ is an injection. We say $g$ has \emph{unique labels} if
  $g$ has injective labels and no two gates in $W(g, \cdot)$ are
  syntactically-equivalent. We say $C$ has \emph{injective labels} (resp.\
  \emph{unique labels}) if every gate in $C$ has injective labels (resp.\ unique
  labels). We say $C$ is \emph{transparent} if every gate $g$ in $C$ such that
  $\Sigma(g)$ is a non-symmetric function has unique labels.
\end{definition}

We can translate transparent circuits into circuits with unique labels in
polynomial-time. We prove this by first showing that syntactic-equivalence can
be computed for transparent circuits in polynomial-time. This follows from a
straightforward inductive construction on depth, starting from the input gates
and noting that the syntactic-equivalence classes of the next layer can be
computed so long as you can solve the isomorphism problem for the gates in this
next layer. This is easy to do for gates labelled by symmetric functions, as we
can check set-equivalence easily, and in the case the gate is non-symmetric then
this gate has unique labels, and so there is at most one possible function that
is a candidate isomorphism, and so we can check if this single function is an
isomorphism.

\begin{lemma}
  There is an algorithm that takes as input a transparent circuit $C$ and
  outputs the syntactic-equivalence relation on the gates of $C$. The algorithm
  runs in time polynomial in the size of $C$.
  \label{lem:transparent-syntactic-equiv}
\end{lemma}

The translation from transparent circuits to circuits with unique labels is
defined as follows. First we define a circuit by collapsing the gates of the
input circuit into its syntactic-equivalence classes, i.e.\ taking a quotient of
the circuit by syntactic-equivalence. The resultant circuit almost has unique
labels, but for the fact that certain gates computing symmetric functions might
not have injective labels. For each offending gate $g$ and each $h \in W(\cdot,
g)$ that has $t$ wires to $g$ we add in a sequence of $t-1$ single-input
$\AND$-gates and replace $t-1$ wires from $h$ to $g$ with wires from each of
these $\AND$-gates to $g$. This construction gives the following result.

\begin{lemma}
  There is an algorithm that takes as input a $(\BB, \rho)$-transparent circuit
  $C$ such a circuit and outputs a $(\mathbb{B} \cup \mathbb{B}_{\std},
  \rho)$-circuit $C'$ such that $C$ and $C'$ compute the same function, $C'$ has
  unique labels, and if $C$ is symmetric then $C'$ is symmetric. Moreover, this
  algorithm runs in time polynomial in the size of the input circuit.
  \label{lem:transparent-unique}
\end{lemma}

This approach for proving Lemma~\ref{lem:transparent-unique} would not work if
the circuit were not transparent as we would need to know which wires should be
replaced with wires from $\AND$-gates so as to preserve symmetry. It can be
shown that deriving a wiring that preserves symmetry would involve solving an
isomorphism problem.

We have that transparent circuits can be transformed into circuits with unique
labels. We should like to show that circuits with unique labels are analogous to
rigid circuits. We show that (i) circuits with unique extensions have unique
labels and (ii) we can compute the action of an automorphism on a circuit with
unique labels in polynomial-time.

Let $C$ be a circuit with unique labels of order $n$ and let $\sigma \in
\sym_n$. We can define $\pi \in \aut(C)$ as follows. If $g$ is an output or
input gate then the image of $g$ is entirely determined by $\sigma$. Suppose $g$
is an internal gate, and suppose we have constructed $\pi$ for all gates $h$ of
depth greater than $g$. We start from the input gates and inductively construct
a gate $g'$ that, from
Lemma~\ref{lem:permutation-extending-syntactic-equivalence}, must be
syntactically-equivalent to the image of $g$ under $\pi$. We notice that, since
$C$ has unique-extensions, there is at most one child of $ \pi(h)$
syntactically-equivalent to $g'$. We can compute which child this is using
Lemma~\ref{lem:transparent-syntactic-equiv}, and we assign $\pi(g)$ to be that
child. The above construction can also be implemented as a polynomial-time
algorithm, with the additional requirement that we halt and output that no
automorphism exists if at any stage the construction fails. We thus have the
following result.

\begin{lemma}
  There is an algorithm takes as input a $(\BB, \rho)$-circuit $C$ of order $n$
  with unique labels and $\sigma \in \sym_n$ and outputs for each gate $g$ the
  image of $g$ under the action of the unique automorphism extending $\sigma$
  (if it exists). This algorithm runs in time polynomial in the combined size of
  the input circuit and the encoding of the permutation.
  \label{lem:compute-automorphisms}
\end{lemma}

It is not hard to see that at each step in this construction there is only one
way of extending the automorphism to the next layer of gates. We thus have the
following result.

\begin{lemma}
  If $C$ is a circuit with unique labels then $C$ has unique extensions.
  \label{lem:unique-labels-unique-extensions}
\end{lemma}

It remains to use our framework to define a class of circuits with gates that
can compute rank. Let $a, b, r, p \in \nats$, with $p$ prime. Let
$\RANK^r_p[a,b] : \{0,1\}^{[a] \times [b]} \rightarrow \{0,1\}$ be a
matrix-invariant structured function with universe $[a] \uplus [b]$, and such
that $\RANK^r_p[a,b](M) = 1$ if, and only if, the matrix $M \in \{0,1\}^{[a]
  \times [b]}$ has rank at least $r$ over $\ff_p$ when the entries of $M$ are
interpreted as elements of $\ff_p$. Let $\RANK = \{\RANK^{r}_p[a,b] : a, b, r, p
\in \nats, \text{ $p$ prime}\}$ and let the \emph{rank basis} be $\RB := \BM
\cup \RANK$. We call a circuit defined over the rank basis a
\emph{rank-circuit}.

We are now ready to state the main theorem of this paper.

\begin{theorem}[Main Theorem]
  A graph property is decidable by a $\PT$-uniform family of transparent
  symmetric rank-circuits if, and only if, it is definable by an $\FPR$
  sentence.
\end{theorem}


\section{Symmetry and Supports}
In this section we introduce the definition of a support and
supporting partition from~\cite{AndersonD17} and extend the results
about supports to our framework.

\begin{definition}
  Let $G \leq \sym_n$ and let $S \subseteq [n]$. Then $S$ is a \emph{support}
  for $G$ if $\stab_n(S) \leq G$.
\end{definition}

An important generalisation of the notion of a support is a \emph{supporting
  partition}.

\begin{definition}
  Let $G \leq \sym_n$ and $\mathcal{P}$ be a partition of $[n]$. Then
  $\mathcal{P}$ is a \emph{supporting partition} for $G$ if
  $\stab_n(\mathcal{P}) \leq G$.
\end{definition}

Let $\mathcal{P}$ and $\mathcal{P}'$ be supporting partitions for $G$. We say
that $\mathcal{P}'$ is as \emph{coarse} as $\mathcal{P}$, denoted by
$\mathcal{P}' \preceq \mathcal{P}$, if every part in $\mathcal{P}$ is contained
in a part in $\mathcal{P}'$.  Every group $G \leq
\sym_n$ has a unique coarsest supporting partition~\cite{AndersonD17}. We call this partition the
\emph{canonical supporting partition}, and denote it by $\SP (G)$.

It is easy to show that if $\mathcal{P}$ is a supporting partition for $G \leq
\sym_n$ and $P$ is the largest part of $\mathcal{P}$ then $[n] \setminus P$ is a
support for $G$. If $\mathcal{P}$ is the canonical supporting partition for $G$
and $\vert P \vert > \frac{1}{2}$ we call $[n] \setminus P$ the \emph{canonical
  support} for $G$ and denote it by $\consp(G)$.

We apply the language of supports to circuits. Let $C$ be a circuit and $g$ be a
gate in $C$. Let $\orb(g) := \{\pi g : \pi \in \aut(C)\}$ and $\stab (g) := \{
\pi \in \aut(C) : \pi g = g \}$. We say that a partition $\mathcal{P}$ of $[n]$
(resp. a set $S \subseteq [n]$) is a supporting partition for $g$ if
$\mathcal{P}$ is a supporting partition for $\stab(g)$ (resp.\ $S$ is a support
for $\stab(g)$). We abuse notation and write $\SP(g)$ and $\consp(g)$ for the
cononical supporting partition and canonical support for $g$. Let $\| \SP(g) \|$
denote the smallest value of $[n] \setminus P$ for $P \in \SP(g)$. Let $\SP(C)$
denote the largest value of $\| \SP(g) \|$ for $g$ a gate in $C$. We now state
the support theorem and then discuss its proof.

\begin{theorem}
  \label{thm:support-thm}
  For any $\epsilon$ and $n$ such that $\frac{2}{3} \leq \epsilon \leq 1$ and $n
  \geq \frac{128}{\epsilon^2}$, if $C$ is a symmetric circuit of order $n$ with
  unique labels and $s := \max_{g \in C} \vert \orb (g)\vert \leq
  2^{n^{1-\epsilon}}$, then, $\SP(C) \leq \frac{33}{\epsilon}\frac{\log s}{\log
    n}$.
\end{theorem}

The proof follows a strategy broadly similar to the one used
in~\cite{AndersonD17}, and makes use of two lemmas from there. The first of
these lemmas gives us that if the index of a group $G \leq \sym_n$ is small then
$\SP(G)$ either has very few or very many parts. The second lemma gives us that
for $G \leq \sym_n$, if $\SP(G)$ has very few parts then it must have a single
very large part (and hence a small canonical support). These two results allow
us to conclude that every gate $g$ in $C$ has a small canonical support if it
has a canonical supporting partition with very few parts. We then prove by
structural induction that the canonical supporting partition of every gate has
few parts. To be precise, we show that if $g$ is the topologically first gate in
the circuit with a canonical supporting partition with too many parts then
$\vert \orb(g) \vert > 2^{n^{1 - \epsilon}}$, i.e.\ the orbit is larger than the
given bound.

We do this by establishing the existence of a large set $H$ of permutations that
each take $g$ to a different gate. To construct $H$, we define a set of triples
of the form $(\sigma, h, h')$ where $\sigma \in \sym_n$ and $h,h' \in H_g$. Each
of these triples is useful in a sense that it guarantees that $\sigma$ moves
$g$. Moreover, the triples are pairwise independent which means that we can
compose them in arbitrary combinations to generate new permutations moving $g$,
while guaranteeing that each such combination gives us a different element in
the orbit of $g$.

\begin{lemma}
  Let $\mathcal{C} := (C_n)_{n \in \nats}$ be a polynomial-size family of
  symmetric circuits with unique labels. There is a $k$ such that $\SP(C_n) \leq
  k$ for all $n \in \nats$.
  \label{lem:constant-size-support}
\end{lemma}

\subsection*{Supports of Indexes}
In our analysis we not only need to consider supports on gates, but also on
elements of the universe of a gate. For a gate $g$ in $C$ with unique extensions
there is an action of $\stab(g)$ on $\universe{g}$ defined $\sigma \cdot a :=
(\pi_{\sigma}\vec{a}_R) (\vec{a}^{-1}_R(a))$, for $\sigma \in \stab(g)$ and $a
\in \universe{g}$, and where $\vec{a}_R \in \ind(g)$ contains the element $a$.
Since $\pi_{\sigma}$ is an automorphism uniquely determined by $\sigma$ this
action is well-defined.

Since we have a group action of $\stab(g)$ on $\universe{g}$, but not $\sym_n$
on $\universe{g}$, we must speak of the support of $a \in \universe{g}$ relative
to $\stab(g)$. We are often interested in the action of the subgroup
$\spstab{g}$ rather. We let $\stab_{\consp{g}}(a)$ and $\orb_{\consp{g}}(a)$ be
the orbit and stabiliser of $a$ under the action of $\spstab{g}$. We let
$\consp_{\consp(g)}(a)$ and $\SP_{\consp(g)}(a)$ denote the canonical support
and canonical supporting partition of $\stab_{\consp(g)}(a)$. In all cases when
the choice of $g$ is obvious from context we omit the subscript. The following
lemma is a direct consequence of the support theorem. It extends the support
theorem to elements of the universe of a gate.

\begin{lemma}
  \label{lem:row-column-supports}
  Let $(C_n)_{n \in \nats}$ be a polynomial-size family of symmetric circuits
  with unique labels. There exists $n_0, k \in \nats$ such that for all $n >
  n_0$, $g$ a gate $C_n$ and $a \in \universe{g}$
  \begin{itemize}
  \item $\stab_n(g)$, $\stab_{\consp(g)}(a)$ and $\stab_{g}(a)$ have small
    supports,
  \item if $h \in H_g$ and $a$ appears in $L(g)^{-1}(h)$ then
    $\consp_{\consp(g)}(a) \subseteq \consp(g) \cup \consp(h)$, and
  \item $\vert \consp(g) \leq k$ and $\vert \consp_{\consp(g)}(a) \vert \leq
    2k$.
  \end{itemize}
\end{lemma}


\section{The Translation from Formulas into
  Circuits}\label{sec:formulas-to-circuits}
The standard translation from formulas to uniform families of symmetric circuits
does not result in a family of \emph{transparent} circuits. We must thus define
a novel translation. We do this in two parts. We first define a translation from
$\PT$-uniform families of bounded-width $\FOrk$-formulas to equivalent
$\PT$-uniform of transparent symmetric rank-circuits. We then define a
translation from formulas of $\FPR$ to $\PT$-uniform families of bounded-width
$\FOrk$-formulas. The first of these translations is given by the following
lemma.

\begin{lemma}
  There is a function that takes as input a $\FOrk$-formula $\theta(\vec{x})$
  and $n \in \nats$ and outputs a transparent symmetric rank-circuit $C$ of
  order $n$ defined over the same vocabulary as $\theta(\vec{x})$ and that
  computes the query defined by $\theta(\vec{x})$ for structures of size $n$.
  Moreover, this function is computable and there is a polynomial in $p$ such
  that for an input $(\theta(\vec{x}), n)$ the algorithm computing this function
  terminates in at most $p(n^{\width(\theta)}\vert \cl{\theta} \vert)$ many
  steps.
  \label{lem:translating-FOrk}
  
\end{lemma}
\begin{proof}[Proof Sketch]
  
  The proof follows easily once one understands why the usual translation does
  not produce a transparent circuit. Consider the following example. Suppose
  $\psi(\vec{y})$ is a subformula of $\theta(\vec{x})$ of the form $\rank^r_p
  \vec{w} \vec{z} . \phi$ and suppose that $\phi := w_1 \land w_2$. In this case
  the syntactic structure of $\phi$ is fixed by all permutations of the
  variables $\vec{w} \cup \vec{z}$ that fix $\{w_1, w_2\}$ set-wise. The usual
  translation to circuits would preserve these symmetries, resulting in most of
  the input gates of the rank gate being syntactically-equivalent.
  
  In order to address this we first preprocess the formula $\theta(\vec{x})$,
  defining a new formula $\lambda (\vec{x})$ that decides the same query but is
  defined so as to include \emph{only} those symmetries that follow from the
  natural symmetry of the rank gate, and not those introduced by a particular
  application. We define $\lambda(\vec{x})$ as follows. Let $R$ be a relation
  symbol in the vocabulary of $\theta(\vec{x})$ (if the vocabulary is empty the
  translation is trivial). For a variable $y$ let $\op{no-op}(y) := (R(y, y)
  \lor (\neg R(y, y)))$. For a sequence of variables $\vec{y} = (y_1, \ldots,
  y_m)$ let $\op{tag} (\vec{y}) := (\op{no-op}(y_1) \land (\op{no-op}(y_2) \land
  ( \op{no-op}(y_2) \land ( \ldots \land (\op{no-op}(y_m)) \ldots))))$. Let
  $\lambda (\vec{x})$ be the formula constructed from $\theta(\vec{x})$ by
  replacing each sub-formula $\psi(\vec{y})$ of the form $\rank^r_p \vec{w}
  \vec{z} . \phi$ with the formula $\rank^r_p \vec{w}\vec{z} . ((\forall u . u =
  u) \land \phi) \land \op{tag}(\vec{w} \cup \vec{z})$. Since we always replace
  a subformula $\phi$ with a logically equivalent formula, it follows that
  $\lambda (\vec{x})$ and $\theta (\vec{x})$ are equivalent. The intuition is
  that $\op{tag}(\vec{w} \cup \vec{z})$ appends a tower of conjunctions of
  tautologies, with each tautology referencing a unique variable from $\vec{w}
  \cup \vec{z}$. When we construct the circuit, this tower of tautologies acts
  to `tag' each input to the rank gate with a unique gadget.

  We then construct $C$ using the usual approach. For each $\psi(\vec{y})$ a
  subformula of $\lambda(\vec{x})$ and each assignment $\vec{a} \in [n]^{\vert
    \vec{y} \vert}$ to $\vec{y}$ we include a gate $g_{\psi, \vec{a}}$ in $C$.
  We wire the circuit such that $g_{\phi, \vec{a}}$ is an input gate to
  $g_{\psi, \vec{b}}$ if, and only if, $\phi$ is an immediate subformula of
  $\psi$ and the two assignments never assign the same variable to two different
  values. For more details on this translation see~\cite{DW-arxiv}.
\end{proof}

The translation from $\FPR$ to $\PT$-uniform families of bounded-width
$\FOrk$-formulas is a concatenation of the following two translations. First,
from~\cite{Dawar09logicswith}, we can translate $\theta(\vec{x}) \in \FPR[\tau]$
of width $t$ into an equivalent $\PT$-uniform family of $\FOR[\tau]$-formulas.
Second, from~\cite{libkin2004elements}, we can translate $\FOR[\tau]$-formulas
into equivalent $\PT$-uniform families of $\FOrk[\tau]$-formulas. Both of these
translations increase width by a constant factor. This translation, combined
with Lemma~\ref{lem:translating-FOrk}, allows us to prove the following.

\begin{theorem}
  For each $\FPR$-formula $\theta(\vec{x})$ there exists a $\PT$-uniform family
  of transparent symmetric rank-circuits$(C_n)_{n \in \nats}$ that defines the
  same query as $\theta(\vec{x})$.
  \label{thm:translating-formulas-to-circuits}
\end{theorem}

\section{The Translation from Circuits into
  Formulas}\label{sec:circuits-to-formulas}
We leverage the support theorem and the various polynomial-time algorithms
defined for transparent circuits and circuits with unique labels in order to
define a translation from $\PT$-uniform families of symmetric rank-circuits to
formulas of $\FPR$. Let $\mathcal{C} = (C_n)_{n \in \nats}$ denote a
$\PT$-uniform family of transparent symmetric $(\RB, \rho)$-circuits computing a
$q$-ary query $Q$.

From the Immerman-Vardi theorem~\cite{Immerman198686, Vardi:1982} and
Lemma~\ref{lem:transparent-unique}, there is a $t$-width interpretation $\Phi$
such that for each $\rho$-structure $\mathcal{A}$ of size $n$ the interpretation
of $\Phi$ in $\mathcal{A}$ defines a symmetric rank-circuit with unique labels
(in the number universe) equivalent to $C_n$. We aim to show that there exists
$\theta_Q \in \FPR[\rho]$ that defines $Q$, i.e.\ such that $\mathcal{A} \models
\theta_Q[\vec{a}]$ if, and only if, $C_n[\gamma \mathcal{A}](\Omega (\gamma
\vec{a})) = 1$ for any bijection $\gamma \in [n]^{\underline{U}}$.

% We first show how to recursively evaluate the gates of a circuit and then show
% that this recursive evaluation can be implemented in $\FPR$ using the
% fixed-point operator.

Let $n_0$ and $k$ be the constants in the statement of
Lemma~\ref{lem:row-column-supports}. Notice that for each $n \leq n_0$ there are
only constantly many bijections from the universe of a structure to $[n]$, and
so we can explicitly quantify over these constantly many bijections and evaluate
the circuit. We thus fix $n > n_0$ and a $\rho$-structure $\mathcal{A}$ with
universe $U$ of size $n$ and show how to evaluate $C_n$

It follows from Lemma~\ref{lem:row-column-supports} that each gate $g$ has a
support of size at most $k$ and each $a \in \universe{g}$ has a support of size
at most $2k$. We say that two injections $f$ and $g$ are \emph{compatible} if
there is an injection on the union of their domains that agrees with both
functions. If there is such a function then it is clearly unique, and we denote
it by $(f \vert g)$. We use $\sim$ to denote that two injections are compatible.
The following result gives us that the evaluation of a gate $g$ for input
$\mathcal{A}$ and bijection $\gamma \in [n]^{\underline{U}}$ depends only on
those elements $\gamma$ maps to $\consp(g)$.

\begin{lemma}
	Let $g$ be a gate in $C_n$. Let $\eta \in U^{\underline{\consp(g)}}$ and
  $\gamma_1, \gamma_2 \in [n]^{\underline{U}}$ such that $\gamma^{-1}_1 \sim
  \eta$ and $\gamma^{-1}_2 \sim \eta$. Then $L^{\gamma_1 \mathcal{A}}(g)$ and
  $L^{\gamma_2 \mathcal{A}}(g)$ are isomorphic.
	\label{lem:support-determines-evaluation}
\end{lemma}

It follows from Lemma~\ref{lem:support-determines-evaluation} that the
evaluation of $g$ is entirely determined by $\EV_g := \{ \eta \in
U^{\underline{\consp(g)}} : \exists \gamma \in [n]^{\underline{U}}\text{ s.t. }
C_n[\gamma \mathcal{A}](g) = 1 \text{ and } \eta \sim \gamma^{-1}\}$. Here we
see how the support theorem allows us to characterize the evaluation of a gate
succinctly.

The query defined by $C_n$ for $\mathcal{A}$ is $Q = \{ \vec{a} \in U^{q} :
\exists g \in G , \vec{x} \in \EV_g \text{ s.t. } \Omega(\vec{x}^{-1}(\vec{a}))
= g\}$. In order to define $Q$ it is thus sufficient to show that $\EV_g$ is
$\FPR$-definable. In particular, we show that there is an $\FPR$-definable
relation $V \subseteq [n^t] \times U^k$ such that $(g, \vec{x}) \in V$ if, and
only if, $\overline{x}$ is the restriction of $\vec{x}$ to $\vert \consp(g)
\vert$ elements and the assignment that maps $\consp(g)$ to $\overline{x}$ is in
$\EV_g$. We do this by first describing a procedure for recursively defining
$\EV_g$, i.e.\ defining $\EV_g$ given $\{\EV_h : h \in H_g \}$, and then arguing
that this definition can be implemented in $\FPR$. This suffices as we may then
use the fixed-point operator to complete the definition of $V$. The gate $g$ is
either a symmetric gate or a rank gate. If $g$ is a symmetric gate then we have
a $\FPC$-definable recursive construction of $\EV_g$ from~\cite{AndersonD17}. As
such, we assume $g$ is a rank gate.

As an aside, we note that the recursive construction of $\EV_g$
in~\cite{AndersonD17} relies on the fact that if $g$ is symmetric then it can be
evaluated by counting the number of its inputs that evaluate to $1$. Using this
fact, along with a bijection between the orbit of a gate and the assignments to
the support of that gate, the problem of evaluating $g$ reduces to a counting
problem on the assignments to the supports of the inputs to $g$. The results
that underlie this counting argument fail for non-symmetric gates, and so we are
forced to use a very different approach for rank gates.

We instead show that for each gate $g$ and $\eta \in U^{\underline{\consp(g)}}$
there is an $\FPR$-definable matrix $M$ that has the same rank as $L^{\gamma
  \mathcal{A}}(g)$ for any $\gamma \in [n]^{\underline{U}}$ such that
$\gamma^{-1} \sim \eta$. We can then check if $\eta \in \EV_g$ by applying the
rank operator to $M$ and testing against the threshold.

We introduce some notation. Let $A \times B := \ind(g)$. For $h \in H_g$ let
$\row(h) := L(g)^{-1}(h)(1)$ and $\column(h) := L(g)^{-1}(h)(2)$. Let $A_h := \{
\vec{x} \in U^{\underline{\consp(h)}} : \eta \sim \vec{x} \}$ and for all $a \in
\universe{g}$ let $A_a = \{\vec{x} \in U^{\underline{\consp(a)}} : \eta \sim
\vec{x}\}$.

We first define the index sets for the matrix $M$. Let $R^{\min} := \{\min
(\orb(\row(h))) : h \in H_g\}$ and $C^{\min} := \{ \min (\orb (\column(h))) : h
\in H_g\}$. Let $I := \{(i, \vec{x}): i \in R^{\min}, \vec{x} \in A_i\}$ and $J
:= \{(j, \vec{y}): j \in C^{\min}, \vec{y} \in A_j\}$. We think of $R^{\min}$
and $C^{\min}$ as indexing the orbits of the row and column elements under the
action of $\stab(\consp(g))$, with each orbit indexed by the minimal element in
$A$ (or $B$, respectively) that appears in it. We think of $I$ and $J$ as
indexing the elements within an orbit instead by elements of $A_i$ and $A_j$,
implicitly using the bijection between these sets and the orbits of $\row(h)$
and $\column(h)$.

We associate with each index $((i, \vec{x}), (j, \vec{y})) \in I \times J$ a
gate $h$ and an assignment $\vec{w}$ to the support of $h$ as follows. It can be
shown that there is a $\sigma \in \stab(g)$ such that $\vec{y} \sigma$ is
compatible with both $\eta$ and $\vec{x}$. Let $h = L(g)(i, \sigma j)$ and let
$\vec{w} = (\vec{x} \vert \vec{y} \sigma)$. We define the matrix $M : I \times J
\ra \{0,1\}$ by $M((i , \vec{x}), (j, \vec{y})) := \vec{w} \in \EV_h$.

Let $x$ be a gate in $H_g$ or an element of the universe of $g$. Let $f \in
U^{\underline{\consp(x)}}$ and $\gamma \in [n]^{\underline{U}}$ such that
$\gamma^{-1} \sim \eta$. Let $\Pi^{\gamma}_{f} \in \spstab{g}$ be such that
$\Pi^{\gamma}_f (a) = \gamma (f(a))$ for all $a \in \consp(x)$. It is easy to
see that $\Pi^{\gamma}_f(x)$ is well-defined. For a fixed $h \in H_g$, the
mapping $\vec{z} \mapsto \Pi^{\gamma}_{\vec{z}}(h)$, for $\vec{z} \in A_h$,
establishes a correspondence between $A_h$ and the orbit of $h$. A similar
correspondence exists for a fixed $a \in \universe{a}$. It follows that $\vec{z}
\in \EV_h$ if, and only if, $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}}(h))
= 1$. \cite{DW-arxiv}

We use this correspondence to define a mapping from $M$ to $L^{\gamma
  \mathcal{A}}(g)$. Let $\alpha^{\gamma}: I \rightarrow A$ and $\beta^{\gamma}:
J \rightarrow B$ be defined by $\alpha^{\gamma} (i, \vec{x}) :=
\Pi^{\gamma}_{\vec{x}}(i)$ and $\beta^{\gamma} (j, \vec{y}) :=
\Pi^{\gamma}_{\vec{y}}(j)$, respectively. It is possible to show that
$(\alpha^{\gamma}, \beta^{\gamma})$ is a surjective homomorphism from $M$ to
$L^{\gamma\mathcal{A}}(g)$. It can be shown that $\alpha^{\gamma}(i, \vec{x}) =
\alpha^{\gamma}(i, \vec{x}')$ if, and only if, there exists $\pi \in
\stab_{\consp(g)}(i)$ such that $\vec{x} = \vec{x}' \pi$ -- and a similar result
holds for $\beta^{\gamma}$. It follows that $(\alpha^{\gamma}, \beta^{\gamma})$
is not, in general, injective.

We resolve this problem by quotienting. Let $s \in \universe{g}$ and $\vec{x},
\vec{x}' \in A_s$. We say that $\vec{x} \approx \vec{x}'$ if, and only if, there
exists $\pi \in \stab(s)$ such that $\vec{x} = \vec{x}' \pi$. For $(i, \vec{x}),
(i', \vec{x}') \in I$ we say that $(i, \vec{x}) \approx (i', \vec{x}')$ if, and
only if, $i = i'$ and $\vec{x} \approx \vec{x}'$. We similarly define $\approx$
on $J$.

It is easy to see that $\alpha^{\gamma}$ and $\beta^{\gamma}$ are constant on
$\approx$-equivalence classes. As such, the quotient functions $\alpha^\gamma
/_\approx$ and $\beta^{\gamma} /_\approx$ are well-defined. We can also show
that $M((i, \vec{x}, (j, \vec{y}))) = M((i',\vec{x}'), (j', \vec{y}'))$ if $(i,
\vec{x}) \approx (i', \vec{x}')$ and $(j, \vec{y}) \approx (j', \vec{y}')$. Let
$M_{\approx} : I /_{\approx} \times J /_\approx \rightarrow \{0,1\}$ be defined
by $M_\approx ((i, [\vec{x}])_\approx, (j, [\vec{y}])_\approx) := M((i,\vec{x}),
(j, \vec{y}))$. It follows from the previous observation that this function is
well-defined.

Since $(\alpha^{\gamma}, \beta^{\gamma})$ is a surjective homomorphism,
$(\alpha^{\gamma} /_\approx, \beta^{\gamma} /_\approx)$ is a surjective
homomorphism from $M_\approx$ to $L^{\gamma \mathcal{A}}(g)$. Moreover, it
follows from the previous comment on the failure of injectivety that
$(\alpha^{\gamma} /_\approx, \beta^{\gamma} /_\approx)$ is an injection. We thus
have the following result.

\begin{theorem}
	Let $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim \eta$. Then
  $L^{\gamma \mathcal{A}}(g)$ is isomorphic to $M_{\equiv}$.
	\label{thm:LM-equivalence}
\end{theorem}

It is not hard to show that the rows $M ((i, \vec{x}), \cdot)$ and $M((i',
\vec{x}'), \cdot)$ are equal if $(i, \vec{x}) \approx (i' \vec{x}')$, and so
$\rank_p (M) = \rank_p(M_\equiv)$. From this and
Theorem~\ref{thm:LM-equivalence} we have the following result.

\begin{lemma}
	Let $\gamma \in U^{\underline{n}}$ be such that $\gamma^{-1} \sim \eta$ and
  let $p \in \nats$ be prime. Then $\rank_p (M) = \rank_p (M_\equiv) = \rank_p
  (L^{\gamma \mathcal{A}}(g))$.
  \label{lem:rank-triple-equivilence}
\end{lemma}

It remains to justify our assertion that the above recursive definition of
$\EV_g$ can be implemented in $\FPR$. It is sufficient to show that there is an
$\FPR$-formula that defines $M$ for a rank gate $g$ and assignment $\eta \in
U^{\underline{\consp(g)}}$. We first show that the sets $\{(g, \consp(g)) : g
\in G\}$, $I$, and $J$ are $\FPR$-definable. We have the following results as a
consequence of Lemma~\ref{lem:compute-automorphisms}.

\begin{lemma}
  There is an algorithm that takes in a circuit $C$ with unique labels and
  outputs if the circuit is symmetric. If it is symmetric then it outputs for
  each gate $g$ and $a \in \universe{g}$ the orbit $\orb(g)$ and canonical
  supporting partition $\SP(g)$, as well as $\orb_{\consp(g)}(a)$ and
  $\SP_{\consp(g)}(a)$. This algorithm runs in time polynomial in the size of
  the circuit.
  \label{lem:computing-support-orbit-gate}
\end{lemma}

From Lemma~\ref{lem:computing-support-orbit-gate} and the Immerman-Vardi theorem
there are $\FPC$-formulas that define the canonical support and orbit for each
gate $g$ and each $a \in \universe{g}$. Moreover, it can be shown that
compatibility between assignments to supports is $\FPR$-definable. It follows
that we can define $A_a$ for each $a \in \universe{g}$ and $A_h$ for each $h \in
H_g$. Combining these results we have that $I$ and $J$ are $\FPR$-definable. We
then define $M$ using a relation symbol $V'$ that denotes value of $V$ at this
stage in the recursive construction. This completes the $\FPR$-definition of $M$
and so $\EV_g$, and hence the proof of our main result.

\section{Concluding Remarks and Future Work}
$\FPR$ is one of the most expressive logics we know that is still contained in
$\PT$ and understanding its expressive power is an important question. The main
result of this paper establishes an equivalence between the expressive power of
$\FPR$ and the computational power of uniform families of transparent symmetric
rank-circuits. Not only does this establish an interesting
characterization of an important logic, it also deepens our understanding of
the connection between logic and circuit complexity and sheds new
light on foundational aspects of the circuit model.

The circuit characterisation helps emphasise certain important aspects of
the logic. Given that $\PT$-uniform families of invariant circuits (without the
restriction to symmetry) express all properties on $\PT$, we can understand the
inability of $\FPC$ (and, conjecturally, $\FPR$) to express all such properties
as essentially down to symmetry. As with other (machine) models of computation,
the translation to circuits exposes the inherent combinatorial structure of an
algorithm. In the case of logics, we find that a key property of this structure
is its symmetry and the translation to circuits provides us with the tools to
study it.

Still, the most significant contribution of this paper is not in the main result
but in the techniques that are developed to establish it, and we highlight some
of these now. The conclusion of~\cite{AndersonD17} says that the support theorem
is ``largely agnostic to the particular [\ldots] basis'', suggesting that it
could be easily adapted to include other gates. This turns out to have been a
misjudgment. Attempting to prove the support theorem for a basis that includes
rank threshold gates showed us the extent to which both the proof of the theorem
and, more broadly, the definitions of circuit classes, rest heavily on the
assumption that all functions computed by gates are symmetric. Thus, in order to
define what the ``symmetry'' condition might mean for circuits that include rank
threshold gates, we radically generalise the circuit framework to allow for
gates that take structured inputs (rather than sets of $0$s and $1$s) and are
invariant under isomorphisms. This leads to a refined notion of circuit
automorphism, which allows us to formulate a notion of symmetry and prove a
version of the support theorem. Again, in that proof, substantial new methods
are required.

% While the new framework allows us to reproduce some results such as the support
% theorem, something is lost in the generalisation. When our basis contains only
% symmetric functions, important properties of a circuit, including the symmetry
% of the circuit itself, are easily decidable. In the new framework, checking
% circuit automorphism requires checking isomorphism of structured inputs to gates
% and codes hard problems. For this reason, we imposed a further restriction to
% the circuits in the form of \emph{transparency}. But, it should be clear that
% this is a restriction only in the broader framework. All symmetric circuits with
% only symmetric gates are transparent. Thus, transparent, symmetric circuits are
% still a generalisation of those considered in~\cite{AndersonD17}.

The condition of \emph{transparency} makes the translation of uniform circuit families
into formulas of logic (which is the difficult direction of our
characterisation) possible, but it complicates the other direction. Indeed, the
natural translation of formulas of $\FPR$ into uniform circuit families yields
circuits which are symmetric, but not transparent. This problem is addressed by
introducing gadgets in the translation---which for ease of exposition, we did in
formulas of $\FOrk$ which are then translated into circuits in the natural way.
Thus, the restriction to transparent circuits is sufficient to get both
directions of the characterisation. 

In short, we can represent the proof of our characterisation through the three
equivalences in this triangle.

\begin{center}
  \begin{tikzcd}
    \FPR \ar[r, equal] \ar[dr, equal] & \parbox{0.35\textwidth}{Uniform families
      of
      bounded-width $\FOrk$ formulas}  \ar[d, equal]\\
    & \parbox{0.38\textwidth}{Uniform families of transparent symmetric
      rank-circuits}
  \end{tikzcd}
\end{center}

This highlights another interesting aspect of our result. The first translation,
of $\FPR$ to uniform families of $\FOrk$ formulas was given
in~\cite{Dawar09logicswith} and used there to establish arity lower bounds.
However, this was for a weaker version of the rank logic rather than the
strictly more expressive one defined by Gr\"{a}del and Pakusa~\cite{GradelP15a}.
The fact that we can complete the cycle of equivalences with the more powerful
logic demonstrates that the definition of Gr\"{a}del and Pakusa is the ``right''
formulation of $\FPR$.

\subsection*{Future Work}
There are many directions of work suggested by the methods and results developed
in this paper. First of all, there is the question of transparency. We introduce
it as a technical device that enables our characterisation to go through. Could
it be dispensed with? Or are $\PT$-uniform families of transparent symmetric
rank-circuits strictly weaker than families without the restriction of
transparency? 

The framework we have developed for working with circuits with structured inputs
is very general and not specific to rank gates. It
would be interesting to apply this framework to other logics. It appears to be
as general a way of extending the power of circuits as Lindstr\"om quantifiers
are in the context of logic. We would like to develop this link further, perhaps
for specific quantifiers such as $\FP$ extended by an operator that expresses
the solubility of systems of equations over rings as in~\cite{DGHKP}

At the moment, we have little by way of methods for proving inexpressibility
results for $\FPR$, whether we look at it as a logic or in the circuit model.
The logical formulation lays emphasis on some parameters (the number of
variables, the arity of the operators, etc.) which we can treat as resources
against which to prove lower bounds. On the other hand, the circuit model brings
to the fore other, more combinatorial, parameters. One such is the fan-in of
gates and a promising and novel approach is to try and prove lower bounds for
symmetric circuits with gates with bounded fan-in. We might ask if it is
possible to compute $\AND[3]$ using a symmetric circuit with gates that have
fan-in two. Perhaps we could also combine the circuit view with lower-bound
methods from logic, such as pebble games. Dawar~\cite{Dawar2016} has shown how
the bijection games of Hella~\cite{Hella19961} can be used directly to prove
lower bounds for symmetric without reference to the logic. We also have pebble
games for $\FPR$~\cite{DawarH2012}, and it would be interesting to know if we
can use these on circuits and how the combinatorial parameters of the circuit
interact with the game.

Finally, we note that some of the interesting directions on the interplay
between logic and symmetric circuits raised in~\cite{AndersonD17} remain
relevant. Can we relax the symmetry condition to something in between requiring
invariance of the circuit under the full symmetric group (the case of symmetric
circuits) and requiring no invariance condition at all? Can such restricted
symmetries give rise to interesting logics in between $\FPR$ and $\PT$? It also
remains a challenge to find a circuit characterisation of $\CPTC$. Could the
general framework for non-symmetric gates we have developed here help in this
respect?

% \appendix

\bibliography{references.bib}
% \bibliography{lipics-v2018-sample-article}


\end{document}
