
\documentclass[a4paper,UKenglish]{lipics-v2018}
% This is a template for producing LIPIcs articles. See lipics-manual.pdf for
% further information. for A4 paper format use option "a4paper", for US-letter
% use option "letterpaper" for british hyphenation rules use option "UKenglish",
% for american hyphenation rules use option "USenglish" for section-numbered
% lemmas etc., use "numberwithinsect"

%\usepackage{microtype}%if unwanted, comment out or use option "draft"


\usepackage{xspace}
\usepackage{mymacros}

% 
\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}% the recommnded bibstyle

\title{Symmetric Circuits for Rank Logic}

% \titlerunning{Dummy short
% title}%optional, please use if title is longer than one line

\author{Anuj Dawar}{University of Cambridge Computer Laboratory\\{Cambridge,
    UK}}{anuj.dawar@cl.cam.ac.uk}{}{}%mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty.

\author{Gregory Wilsenach}{University of Cambridge Computer
  Laboratory\\{Cambridge, UK}}{gregory.wilsenach@cl.cam.ac.uk}{}{Funding
  provided by the Gates Cambridge Scholarship}

\authorrunning{A. Dawar and G. Wilsenach} %mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et. al.'

\Copyright{Anuj Dawar and Gregory
  Wilsenach} %mandatory, please use full first names. LIPIcs license is "CC-BY"; http://creativecommons.org/licenses/by/3.0/

\subjclass{F.1.3 Complexity Measures and Classes, F.4.1 Math.
  Logic} % mandatory: Please choose ACM 2012 classifications from https://www.acm.org/publications/class-2012 or https://dl.acm.org/ccs/ccs_flat.cfm . E.g., cite as "General and reference $\rightarrow$ General literature" or \ccsdesc[100]{General and reference~General literature}.

\keywords{Dummy keyword}%mandatory

\category{}%optional, e.g. invited paper

\relatedversion{}%optional, e.g. full version hosted on arXiv, HAL, or other respository/website

\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...

\funding{}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

\acknowledgements{I want to thank \dots}%optional

% Editor-only macros:: begin (do not touch as
% author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access} \EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016} \EventAcronym{CVIT} \EventYear{2016}
\EventDate{December 24--27, 2016} \EventLocation{Little Whinging, United
  Kingdom} \EventLogo{} \SeriesVolume{42} \ArticleNo{23}
% \nolinenumbers %uncomment to disable line numbering
% \hideLIPIcs %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

\begin{abstract}
We give a circuit characterization for fixed-point logic with rank
(FPR) in terms of families of symmetric circuits with rank gates,
along the lines of that for fixed-point logic with counting (FPC)
given by [Anderson and Dawar 2017].  This requires the development of
a broad framework of circuits in which the individual gates compute
functions that are not symmetric (i.e., invariant under all
permutations of their inputs).  In the case of FPC, the proof of
equivalence of circuits and logic rests heavily on the assumption that
individual gates compute such symmetric function and so novel
techniques are required to make this work for FPR.
\end{abstract}

\section{Introduction}

The study of extensions of fixed-point logics plays an important role in the
field of descriptive complexity theory. In particular, fixed-point logic with
counting ($\FPC$) has become a reference logic in the search for a logic for
polynomial-time (see~\cite{Dawar-siglog}). In this context, Anderson and
Dawar~\cite{AndersonD17} provide an interesting characterisation of the
expressive power of $\FPC$ in terms of circuit complexity. They show that the
properties expressible in this logic are exactly those that can be decided by
polynomially-uniform families of circuits (with threshold gates) satisfying a
natural \emph{symmetry} condition. Not only does this illustrate the robustness
of $\FPC$ as a complexity class within $\PT$ by giving a distinct and natural
characterization of it, it also demonstrates that the techniques for proving
inexpressibility in the field of finite model theory can be understood as
lower-bound methods against a natural circuit complexity class. This raises an
obvious question (explicitly posed in the concluding section
of~\cite{AndersonD17}) of how to obtain circuit characterizations of logics more
expressive than $\FPC$, such as choiceless polynomial time (CPT) and fixed-point
logic with rank ($\FPR$). It is this last question that we address in this
paper.

Fixed-point logic with rank extends the expressive power of $\FPC$ by means of
operators that allow us to define the rank of a matrix over a finite field. Such
operators are natural extensions of counting---counting the dimension of a
definable vector space rather than just the size of a definable set. At the same
time they make the logic rich enough to express many of the known examples that
separate $\FPC$ from $\PT$. Rank logics were first introduced
in~\cite{Dawar09logicswith}. The version $\FPR$ we consider here is that defined
by Gr\"adel and Pakusa~\cite{GradelP15a} where the prime characteristic is a
parameter to the rank operator, and we do not have a distinct operator for each
prime number. Formal definitions of these logics are given in
Section~\ref{sec:background}. We give a circuit characterization, in terms of
symmetric circuits, of $\FPR$. One might think, at first sight, that this is a
simple matter of extending the circuit model with gates for computing the rank
of a matrix. It turns out, however, that the matter is not so simple as the
symmetry requirement interacts in surprising ways with such rank gates. It
requires a new framework for defining classes of such circuits, which yields
remarkable new insights.

It is important to clarify at the outset what is meant by symmetric circuits.
Indeed, there are different senses in which the word \emph{symmetry} is used in
the context of circuits (and also in this paper). We say that a Boolean function
$f:\{0,1\}^n \ra \{0,1\}$ is symmetric if the value of the function on a string
$s$ is determined by the number of $1$s in $s$. In other words, $f$ is invariant
under \emph{all} permutations of its input. In contrast, when we consider the
input to a Boolean function to be the adjacency matrix of an $n$-vertex graph,
for example, and $f : \{0,1\}^{n \choose 2} \ra \{0,1\}$ decides a graph
property, then $f$ is invariant under all permutations of its input induced by
permutations of the $n$ vertices of the graph. We call such a function
\emph{graph-invariant}. More generally, for a relational vocabulary $\tau$ and a
standard encoding of $n$-element $\tau$-structures as strings over $\{0,1\}$, we
can say that function taking such strings as input is $\tau$-invariant if it is
invariant under permutations induced by the $n$ elements. A circuit $C$
computing such an invariant function is said to be \emph{symmetric} if every
permutation of the $n$ elements extends to an automorphism of $C$. It is
families of symmetric circuits in this sense that characterize $\FPC$
in~\cite{AndersonD17}. The restriction to symmetric circuits arises naturally in
the study of logics and has appeared previously under the names of generic
circuits in the work of~\cite{DENENBERG1986216} and explicitly order-invariant
circuits in the work of Otto~\cite{Otto1997}.

The main result of~\cite{AndersonD17} says that the properties of
$\tau$-structures definable in $\FPC$ are exactly those that can be decided by
$\PT$-uniform families of symmetric circuits using AND, OR, NOT and majority
gates. Note that each of these gates itself computes a Boolean function that is
symmetric in the strong sense identified above. On the other hand, a gate for
computing a rank threshold function, e.g.\ one that takes as input a $n \times
n$ matrix and outputs $1$ if the rank of the matrix is greater than a threshold
$t$, is \emph{not} symmetric. In our circuit characterization of $\FPR$ we
necessarily have to consider such non-symmetric gates. Indeed, we show in
Section~\ref{sec:symm-circ} that $\PT$-uniform families of symmetric circuits
using gates for \emph{any} symmetric functions do not take us beyond the power
of $\FPC$. This is a further illustration of the robustness of $\FPC$. In order
to go beyond it, we need to introduce gates for Boolean functions that are not
symmetric. We construct a systematic framework for including functions computing
$\tau$-invariant functions for arbitrary multi-sorted relational vocabularies
$\tau$ in Section~\ref{sec:symm-circ}. We also explore what it means for such
circuits to be symmetric.

The proof of the circuit characterization of $\FPC$ relies on the \emph{support
  theorem} proved in~\cite{AndersonD17}. This establishes that for any
$\PT$-uniform family of circuits using $\AND$, $\OR$, $\NOT$ and majority gates there is
a constant $k$ such that every gate has a support of size at most $k$. That is
to say that we can associate with every gate $g$ in the circuit $C_n$ (the
circuit in the family that works on $n$-element structures) a subset $X$ of
$[n]$ of size at most $k$ such that any permutation of $[n]$ fixing $X$
pointwise extends to an automorphism of $C_n$ that fixes $g$. This theorem is
crucial to the translation of the family of circuits into a formula of $\FPC$,
which is the difficult (and novel) direction of the equivalence. In attempting
to do the same with circuits that now use rank-threshold gates we are faced with
the difficulty that the proof of the support theorem in~\cite{AndersonD17}
relies in an essential way on the fact that the Boolean function computed at
each gate is symmetric. We are able to overcome this difficulty and prove a
support theorem for circuits with rank gates but this requires substantial,
novel technical machinery, which we develop in Section~\ref{sec:symm-support}.

Another crucial ingredient in the proof of Anderson and Dawar is that we can
eliminate redundancy in the circuit $C_n$ by making it \emph{rigid}. That is, we
can ensure that the \emph{only} automorphisms of $C_n$ are those that are
induced by permutations of $[n]$. Here we face the difficulty that identifying
the symmetries and eliminting redundancy in a circuit that involves gates
computing $\tau$-invariant functions requires us to solve the isomorphism
problem for $\tau$-structures. This is a hard problem (or, at least, one that we
do not know how to solve efficiently) even when the $\tau$-structures are
$0$-$1$-matrices. We overcome this difficulty by placing a further restriction
on circuits that we call \emph{transparency}. Circuits satisfying this condition
have the property that their lack of redundancy is transparent. We explore this
condition and its consequences in Section~\ref{sec:transparent}, where we also
demonstrate that something like this requirement is necessary. Natural weakenings
of this requirement yield circuits in which deciding symmetry seems hard.

In the characterization of $\FPC$, the translation from formulas into families
of circuits is easy and, indeed, standard. In our case, we have to show that
formulas of $\FPR$ translate into uniform families of circuits using
rank-threshold gates that are symmetric and transparent. This is somewhat more
involved technically and the details are presented in
Section~\ref{sec:formulas-to-circuits}. Finally, with all these tools in place,
the translation of such $\PT$-uniform families of circuits into formulas of
$\FPR$ given in Section~\ref{sec:circuits-to-formulas} completes the
characterization. This still requires substantial new techniques. The
translation of circuits to formulas in~\cite{AndersonD17} relies on the fact
that in order to evaluate a gate computing a symmetric Boolean function, it
suffices to count the number of inputs that evaluate to true and there is a
bijection between the orbits of a gate and tuple assignments to its support.
When counting is no longer sufficient, this bijection has to preserve more
structure and demonstrating this in the case of matrices requires new insight.


\section{Background}
We assume the reader is familiar with first-order logic ($\FO$), inflationary
fixed-point logic ($\FP$), Fixed-point logic with counting ($\FPC$), and
first-order logic with counting quantifiers ($\FOC$). For details on these
logics please see \cite{grohe2017descriptive, immerman1999descriptive}.
Throughout this paper we assume all algebraic structures are finite.

\subsection{Logic}
\subsection{Rank Logic}
\subsection{Circuits}

\section{Generalising Symmetric Circuits}
A Boolean circuit $C$ is usually taken to be a directed acyclic graph with a set
of input gates labelled by variables and with each internal gate $g$ in the
circuit labelled with a function $f_g$ from a basis $\BB$. However, if $f_g$
were allowed to be arbitrary, then an order would need to be imposed on the
children of $g$ in order to ensure unambiguous evaluation. As such, when we say
that $C$ is a directed acyclic graph, and include no structure on the children
of each gate, we implicitly assume that $f_g$ is invariant under all
permutations of its inputs -- i.e.\ $f_g$ is a symmetric function. As such, this
assumption that the basis consists of only symmetric functions is pervasive in
circuit complexity. Indeed, it is easy to see that the standard Boolean basis
consisting of $\AND$, $\OR$ and $\NOT$, as well as the extension of this basis
with majority or threshold functions, contains only symmetric functions.

Anderson and Dawar's~\cite{AndersonD17} characterisation of $\FPC$ is in terms
of symmetric circuits over the majority basis. We show in this section that this
circuit model cannot be strengthened by extending the basis by symmetric
functions. As our ultimate aim is a circuit characterisation of $\FPR$, whose
expressive power is strictly greater than that of $\FPC$, we would like to
consider circuits defined over bases containing non-symmetric Boolean functions.
In particular, we are interested in bases containing rank-threshold functions --
i.e.\ functions that as input a matrix and decide if the matrix, understood as
having entries in some prime field, has rank less than some threshold. While
these functions are not symmetric in the full sense, they are symmetric in the
sense of being invariant under row-column permutations.

To lead up to this, we first develop a general framework of structured Boolean
functions. These are functions whose inputs naturally encode $\tau$-structures,
rather than just matrices, and where the output is invariant under the natural
symmetries of such structures. The \emph{matrix-invariant} functions (defined
formally below) are a natural particular case. We therefore define symmetric
circuits in a general form where gates can be labelled by
\emph{isomorphism-invariant} structured functions.

Ultimately, our aim is to replicate the results Anderson and
Dawar~\cite{AndersonD17} in this more general setting. A difficulty we face is
that the proof methods in that paper heavily rely on the assumption that the
Boolean functions computed by individual gates are symmetric functions.


\subsection{Structured Functions}
Let $X$ be a finite set and $F: \{0,1\}^X \rightarrow \{0,1\}$. It is often the
case that we are interested in Boolean functions that take in strings, and in
this case we would have $X = [n]$ for some $n \in \nats$. The natural notion of
symmetry for such functions is invariance under arbitrary permutations of $X$,
i.e.\ the usual notion. However, in some cases we are interested in Boolean
functions that take structures as input. For example, if we are interested in
Boolean functions that that as inputs directed graphs we would let $X = V^2$ for
some vertex set $V$. In this case the natural symmetry condition would not be
invariance under arbitrary permutation, but rather invariance under the action
of a permutation of $V$, i.e.\ under the action of an isomorphism. In this
section

In this section we introduce functions that take as input $\tau$-structures,
where $\tau$ is some many-sorted vocabulary. Let $\tau := (R, S, \nu)$ be a
many-sorted vocabulary and let $D := \biguplus_{s \in S} D_{s} = \{(s,d) : d \in
D_s\}$, be a disjoint union of non-empty sets. Let $\str{\tau, D}$ be the
$\tau$-structure with universe $D$ and such that every relation is trivial. We
let $\ind (\tau, D)$ be the set $\biguplus_{R_i\in R} R^{D}_i := \{ (\vec{a}, R)
: \vec{a} \in R^{D}, \, R \in \tau \} $. We call $\ind(\tau, D)$ the \emph{index
  defined by $(\tau, D)$}.

The idea is that $\ind(\tau, D)$ contains all of the potential elements of a a
relation in a $\tau$-structure. We call $F : \{0,1\}^{\ind(\tau, D)} \ra
\{0,1\}$ a \emph{$(\tau, D)$-structured function}, or just \emph{structured
  function}, and we call $\tau$ and $D$ the \emph{vocabulary} and
\emph{universe} of $F$. We call $\ind(\tau, D)$ the \emph{index} of $F$, and
denote it by $\ind(F)$.

Let $H$ be a set. We think of a function $f : X \rightarrow H$ as defining a
labelling of $\str{\tau,D}$ by $H$, and we identify $f$ with this labelled
instance of $\str{\tau, D}$. Let $f: \ind(\tau, D) \ra H$ and $g : \ind (\tau,
D') \ra H$. We say that $f$ and $g$ are \emph{isomorphic} if there is an
isomorphism $\pi : \str{\tau, D} \ra \str{\tau, D'}$ such that $f(\vec{a}_R) =
g(\pi(\vec{a}_R))$ for all $\vec{a}_R \in \ind(\tau, D)$. In other words, $f$
and $g$ are isomorphic if, and only if, they are isomorphic as (labelled)
structures. Notice that if $H = \{0,1\}$ then $f$ and $g$ define
$\tau$-structures and $f$ and $g$ are isomorphic if, and only if, the
$\tau$-structures they define are isomorphic.

We say that $F : \{0,1\}^{\ind(\tau,D)} \ra \{0,1\}$ is
\emph{isomorphism-invariant} if for all $f, g : \ind(\tau, D) \ra \{0,1\}$
whenever $f$ and $g$ are isomorphic then $F(f) = F(g)$.

\subsection{Symmetric Circuits}
We now generalise the circuit model of Anderson and Dawar~\cite{AndersonD17} so
as to allow for circuits to be defined over bases that include non-symmetric
(structured) functions. In this model each gate $g$ is not only associated with
an element of the basis, but also with a labelling function. This labelling
function maps the input gates of $g$ to an appropriate set of labels (i.e. the
index of the structured function associated with $g$). In concord with this
generalisation, we also update the circuit-related notions discussed by Anderson
and Dawar~\cite{AndersonD17}, e.g.\ circuit automorphisms, symmetry, etc.
Moreover, we briefly discuss some of the important complications introduced by
our generalisation, and introduce some of the important tools we will use to
address these complications.

\begin{definition}[Circuits on Structures]
  Let $\mathbb{B}$ be a basis of structured functions and $\rho$ be a relational
  vocabulary, we define a \emph{$(\mathbb{B}, \rho)$-circuit} $C$ of order $n$
  computing a $q$-ary query $Q$ as a structure $\langle G, \Omega, \Sigma,
  \Lambda, L \rangle$.
  \begin{itemize}
    \setlength\itemsep{0mm}
  \item $G$ is called the set of gates of
    $C$.% and $\vert C \vert := \vert G \vert$.
  \item $\Omega$ is an injective function from $[n]^q$ to $G$. The gates in the
    image of $\Omega$ are called the output gates. When $q = 0$, $\Omega$ is a
    constant function mapping to a single output gate.
  \item $\Sigma$ is a function from $G$ to $\mathbb{B} \uplus \rho \uplus
    \{0,1\} $ such that $\vert \Sigma^{-1} (0) \vert \leq 1$ and $\vert
    \Sigma^{-1} (1) \vert \leq 1$. Those gates mapped to $\rho \uplus \{0,1\}$
    are called input gates, with those mapped to $\rho$ called relational gates
    and those mapped to $\{0,1\}$ called constant gates. Those gates mapped to
    $\mathbb{B}$ are called internal gates.
  \item $\Lambda$ is a sequence of injective functions $(\Lambda_{R_i})_{R_i \in
      R}$ such that $\Lambda_{R_i}$ maps each relational gate $g$ with $\Sigma
    (g) = R_i$ to the tuple $\Lambda_{R_i} (g) \in [n]^{r}$. When no ambiguity
    arises we write $\Lambda (g)$ for $\Lambda_{R_i} (g)$.
  \item $L$ associates with each internal gate $g$ a function $L(g):
    \ind(\Sigma(g)) \rightarrow G$ such that if we define a relation $W
    \subseteq G^{2}$ by $W(h_1,h_2)$ iff $h_2$ is an internal gate and $h_1$ is
    in the image of $L(h_2)$, then $(G, W)$ is a directed acyclic graph.
  \end{itemize}
\end{definition}

The definition requires some explanation. Each gate in $G$ computes a function
of its inputs and the relation $W$ on $G$ is the set of ``wires''. That is,
$W(h,g)$ indicates that the value computed at $h$ is an input to $g$. However,
since the functions are structured, we need more information on the set of
inputs to $g$ and this is provided by the labelling $L$. $\Sigma(g)$ tells us
what the function computed at $g$ is, and thus $\ind(\Sigma(g))$ tells us the
structure on the inputs and $L(g)$ maps this to the set of gates that form the
inputs to $g$. We call a gate $g$ a \emph{symmetric gate} if $\Sigma(g)$ is a
symmetric function and $g$ a \emph{non-symmetric gate} otherwise.

Let $\rho$ be a relational vocabulary, $\mathcal{A}$ be a $\rho$-structure with
universe $U$ of size $n$, and $\gamma \in [n]^{\underline{U}}$. Let $\gamma
\mathcal{A}$ be the structure with universe $[n]$ formed by mapping the elements
of $U$ in accordance with $\gamma$. The evaluation of a $(\mathbb{B},
\rho)$-circuit $C$ of order $n$ computing a $q$-ary query $Q$ proceeds by
recursively evaluating the gates in the circuit. The evaluation of the gate $g$
for the bijection $\gamma$ and input structure $\mathcal{A}$ is denoted by
$C[\gamma \mathcal{A}](g)$, and is given as follows:

\begin{itemize}
\item if $g$ is a constant gate then it evaluates to the bit given by
  $\Sigma(g)$,
\item if $g$ is a relational gate then $g$ evaluates to true iff $\gamma
  \mathcal{A} \models \Sigma(g)(\Lambda (g))$, and
\item if $g$ is an internal gate such that $\Sigma (g)$ let $L^{\gamma
    \mathcal{A}}(g): \ind(g) \rightarrow \{0,1\}$ be defined by
  $L^{\gamma\mathcal{A}}(g)(x) = C[\gamma \mathcal{A}](L(g)(x))$, for all $x \in
  \ind(g)$. Then $g$ evaluates to true if, and only if, $\Sigma(g)
  (L^{\gamma}_g) = 1$.
\end{itemize}

We say that $C$ defines the $q$-ary query $Q \subseteq U^q$ under $\gamma$ where
$\vec{a} \in Q$ if, and only if, $C[\gamma \mathcal{A}](\Omega (\gamma \vec{a}))
= 1$.

We now define a circuit automorphism for a circuit.

\begin{definition}[Automorphism]\label{defn:automorphism}
  Let $C = \langle G, \Omega, \Sigma, \Lambda, L\rangle$ be a
  $(\mathbb{B},\tau)$-circuit of order $n$ computing a $q$-ary query, and where
  $\mathbb{B}$ is a basis of isomorphism-invariant structured functions. Let
  $\sigma \in \sym_n$ and $\pi: G \rightarrow G$ be a bijection such that
  \begin{itemize}
  \item for all output tuples $x \in [n]^q$, $\pi \Omega (x) = \Omega (\sigma
    x)$,
  \item for all gates $g \in G$, $\Sigma (g) = \Sigma (\pi g)$,
  \item for each relational gate $g \in G$, $\sigma \Lambda (g) = \Lambda (\pi
    g)$, and
  \item For each pair of gates $g, h \in G$ $W(h,g)$ if and only if $W(\pi h,
    \pi g)$ and for each internal gate $g$ we have that $L(\pi g)$ and $ \pi
    \cdot L(g)$ are isomorphic.
  \end{itemize}
  We call $\pi$ an \emph{automorphism} of $C$, and we say that $\sigma$
  \emph{extends to an automorphism} $\pi$. The group of automorphisms of $C$ is
  called $\aut (C)$.
\end{definition}

We are particularly interested in circuits that have the property that
\emph{every} permutation in $\sym_n$ extends to an automorphism of the circuit.

\begin{definition}[Symmetry]
  A circuit $C$ on structures of size $n$ is called \emph{symmetric} if every
  $\sigma \in \sym_n$ extends to an automorphism on $C$.
\end{definition}

It follows that for any symmetric circuit $C$ of order $n$ there is a
homomorphism $h$ that maps $\sym_n$ to $\aut(C)$ such that if $\sigma \in
\sym_n$ then $h(\sigma)$ is an an automorphism extending $\sigma$. Suppose $C$
does not contain a relational gate labelled by a relation symbol with non-zero
arity. In that case $C$ computes a constant function. For this reason, we always
assume a circuit contains at least one relational gate with non-zero arity. Now,
by assumption there exists a relational gate in $C$ such that some element of
$[n]$ appears in the tuple labelling that gate. By symmetry it follows that
every elements of $[n]$ appears in a tuple labelling a relational gate in $C$.
It follows that no two distinct elements of $\sym_n$ agree on all input gates,
and so the homomorphism $h$ is injective.

If this homomorphism is also surjective then we have that each element of
$\sigma$ extends uniquely to an automorphism of the circuit. In this case we say
that a circuit has \emph{unique extensions}.

\begin{definition}
  We say that a circuit $C$ has \emph{unique extensions} if for every $\sigma
  \in \sym_n$ there is at most one $\pi_{\sigma} \in \aut(C)$ such that
  $\pi_{\sigma}$ extends $\sigma$.
\end{definition}

Many important technical tools, e.g.\ the support theorem, are only applicable
to circuits with unique extensions. In order to address this, Anderson and
Dawar~\cite{AndersonD17} introduce the notion of a \emph{rigid} circuit and show
that there is a polynomial-time computable function that maps a circuit defined
over a basis of symmetric functions to an equivalent rigid circuit. They also
show that a great many properties of rigid circuits can be decided in polynomial
time, a necessary step in their argument, and that rigid circuits have unique
extensions. This allows them to restrict their attention, without a loss of
generality, to $\PT$-uniform families of \emph{rigid} symmetric circuits (over
bases of symmetric functions), and be assured that these circuits have all of
the useful algorithmic and symmetry-related properties necessary for their
result.

We should like to develop a property analogues to rigidity for our framework,
along with a similar polynomial-time translation. However, in our framework the
evaluation of gate $g$ depends (in general) not just on the \emph{set} of
children (and basis element) of a gate, but also the structure on its input
gates. This structure must be preserved by the action of an automorphism, and so
we require that if $\pi$ is an automorphism that maps $g$ to $g'$ then $\pi
L(g)$ and $L(g')$ are isomorphic. Following from this observation, it can be
shown that deciding if a function on the circuit is an automorphism, and indeed
deciding almost any symmetry-related property, for circuits with non-symmetric
gates is at least as hard as the graph-isomorphism problem. As such,
constructing an argument analogous to~\cite{AndersonD17}, as well as
establishing the numerous other crucial results whose proofs rely on the
polynomial-time decidability of various circuit properties, would be beyond the
scope of this paper.

In order to proceed we explicitly restrict our attention to a \emph{transparent}
circuits. We will define this term below, but before we do we need to define a
notion of `structural similarity' between gates that we call
\emph{syntactic-equivalence}.

\begin{definition}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\mathbb{B},
  \rho)$-circuit of order $n$. We recursively define the equivalence relation
  \emph{syntactic-equivalence}, which we denote using the symbol `$\equiv$', on
  $G$ as follows. Suppose $g$ and $h$ are gates in $C$ such that $\Sigma (g) =
  \Sigma(h)$ and either both $g$ and $h$ are output gates and $\Omega^{-1}(g) =
  \Omega^{-1}(h)$ or neither are output gates. Suppose $g$ and $h$ are input
  gates, then $g \equiv h$ if, and only if, both $g$ and $h$ are constant gates
  or both are relational gates and $\Lambda(g) = \Lambda (h)$. Suppose $g$ and
  $h$ are internal gates and suppose we have defined the syntactic-equivalence
  relation for all gates of depth less than the depth of either $g$ or $h$. Then
  $g \equiv h$ if, and only if, $L(g) /_\equiv$ and $L(h) /_\equiv$ are
  isomorphic.
\end{definition}

The intuition is that two gates are syntactically-equivalent if the circuits
underneath these two gates are structurally equivalent. The important point is
that if two gates are mapped to one another by an automorphism that extends the
trivial permutation, then these gates are syntactically-equivalent. In fact, we
can prove a slightly stronger result.

\begin{lemma}
  let $C$ be a circuit of order $n$, $\sigma \in \sym_n$. Let $\pi, \pi' \in
  \aut(C)$ extend $\sigma$. For every $g$ in $C$ we have $\pi (g) \equiv \pi'
  (g)$.
  \label{lem:permutation-extending-syntactic-equivalence}
\end{lemma}

In this way syntactic-equivalence constrains the automorphism group and using
this observation we use syntactic-equivalence to establish sufficient conditions
for a circuit to have unique extensions and, moreover, for various
circuit-properties automorphism

we will show that it can be used to establish unique extensions. Moreover, by
constraining the automorphisms appropriately we might also produce a class of
circuits with all of the algorithmic properties we might need. With these two
ideas in mind we define the following classes of circuits.

\begin{definition}
  Let $C$ be a circuit and $g$ be a gate in $C$. We say $g$ has \emph{injective
    labels} if $L(g)$ is an injection. We say $g$ has \emph{unique labels} if
  $g$ has injective labels and no two gates in $W(g, \cdot)$ are
  syntactically-equivalent. We say $C$ has \emph{injective labels} (resp.\
  \emph{unique labels}) if every gate in $C$ has injective labels (resp.\ unique
  labels). We say $C$ is \emph{transparent} if every gate $g$ in $C$ such that
  $\Sigma(g)$ is a non-symmetric function has unique labels.
\end{definition}

We can translate transparent circuits into circuits with unique labels in
polynomial-time. We prove this by first showing that syntactic-equivalence can
be computed for transparent circuits in polynomial-time. This follows from a
straight forward inductive construction on depth, starting from the input gates
and noting that the syntactic-equivalence classes of the next layer can be
computed so long as you can solve the isomorphism problem for those gates. This
is easy to do for gates labelled by symmetric functions, as we can check
set-equivalence easily, and in the case the gate is non-symmetric then this gate
has unique labels, and so there is at most one possible function that is an
isomorphism, and we check if it's an isomorphism.

\begin{lemma}
  There is an algorithm that takes as input a transparent circuit $C$ and
  outputs the syntactic-equivalence relation on the gates of $C$. The algorithm
  runs in time polynomial in the size of $C$.
  \label{lem:transparent-syntactic-equiv}
\end{lemma}

The translation to circuits with unique labels is defined as follows. First we
define a circuit by collapsing the gates of the input circuit into its
syntactic-equivalence classes, i.e.\ taking a quotient of the circuit by
syntactic-equivalence. The resultant circuit almost has unique labels, but for
the fact that certain gates computing symmetric functions might not have
injective labels. For each offending gate $g$ and each $h \in W(\cdot, g)$ that
has $t$ wires to $g$ we add in a sequence of $t-1$ single-input $\AND$-gates and
replace $t-1$ wires from $h$ to $g$ with wires from each of these $\AND$-gates
to $g$. This construction gives the following result.

\begin{lemma}
  There is an algorithm that takes as input a $(\BB, \rho)$-transparent circuit
  $C$ such a circuit and outputs a $(\mathbb{B} \cup \mathbb{B}_{\std},
  \rho)$-circuit $C'$ such that $C$ and $C'$ compute the same function, $C'$ has
  unique labels, and if $C$ is symmetric then $C'$ is symmetric. Moreover, this
  algorithm runs in time polynomial in the size of the input circuit.
  \label{lem:transparent-unique}
\end{lemma}

This approach for proving Lemma~\cite{lem:trannsparent-unique} would not work if
the circuit were not transparent as we would need to know which wires should be
replaced with wires from $\AND$-gates so as to preserve symmetry. It can be
shown that deriving a wiring that preserves symmetry would involve solving an
isomorphism problem.

We have that transparent circuits can be transformed into circuits with unique
labels. We should like to show that circuits with unique labels are analogous to
rigid circuits. We show that (i) circuits with unique extensions have unique
labels and (ii) we can compute the action of an automorphism on a circuit with
unique labels in polynomial-time.

Let $C$ be a circuit with unique labels of order $n$ and let $\sigma \in
\sym_n$. We can define $\pi \in \aut(C)$ as follows. If $g$ is an output or
input gate then the image of $g$ is entirely determined by $\sigma$. Suppose $g$
is an internal gate, and suppose we have constructed $\pi$ for all gates $h$ of
depth greater than $g$. We start from the input gates and inductively construct
a gate $g'$ that, from
Lemma~\cite{lem:permutation-extending-syntactic-equivalence}, must be
syntactically-equivalent to the image of $g$ under $\pi$. We notice that, since
$C$ has unique-extensions, there is at most one child of $ \pi(h)$
syntactically-equivalent to $g'$. We can compute which child this is using
Lemma~\ref{lem:transparent-syntactic-equiv}, and we assign $\pi(g)$ to be that
child. The above construction can also be implemented as a polynomial-time
algorithm, with the additional requirement that we halt and output that no
automorphism exists if at any stage the construction fails. We thus have the
following result.

\begin{lemma}
  There is an algorithm takes as input a $(\BB, \rho)$-circuit $C$ of order $n$
  with unique labels and $\sigma \in \sym_n$ and outputs for each gate $g$ the
  image of $g$ under the action of the unique automorphism extending $\sigma$
  (if it exists). This algorithm runs in time polynomial in the combined size of
  the input circuit and the encoding of the permutation.
  \label{lem:compute-automorphisms}
\end{lemma}

It is not hard to see that at each step in this construction there is only one
way of extending the automorphism to the next layer of gates. We thus have the
following result.

\begin{lemma}
  If $C$ is a circuit with unique labels then $C$ has unique extensions.
  \label{lem:unique-labels-unique-extensions}
\end{lemma}

It remains to use our framework to define a class of circuits with gates that
can compute rank. Let $a, b, r, p \in \nats$, with $p$ prime. Let
$\RANK^r_p[a,b] : \{0,1\}^{[a] \times [b]} \rightarrow \{0,1\}$ be a
matrix-invariant structured function with universe $[a] \uplus [b]$, and such
that $\RANK^r_p[a,b](M) = 1$ if, and only if, the matrix $M \in \{0,1\}^{[a]
  \times [b]}$ has rank at most $r$ over $\ff_p$ when the entries of $M$ are
interpreted as elements of $\ff_p$. Let $\RANK = \{\RANK^{r}_p[a,b] : a, b, r, p
\in \nats, \text{ $p$ prime}\}$ and let the \emph{rank basis} be $\RB := \BM
\cup \RANK$. We call a circuit defined over the rank basis a
\emph{rank-circuit}.

We are now ready to state the main theorem of this paper.

\begin{theorem}[Main Theorem]
  A graph property is decidable by a $\PT$-uniform family of transparent
  symmetric rank-circuits if, and only if, it is definable by an $\FPR$
  sentence.
\end{theorem}


\section{Symmetry and Supports}
In this section we introduce the definition the definition of a support and
supporting partition from~\cite{AndersonD17} and then generalise their results
about supports for our framework.

\begin{definition}
  Let $G \leq \sym_n$ and let $S \subseteq [n]$. Then $S$ is a \emph{support}
  for $G$ if $\stab_n(S) \leq G$.
\end{definition}

An important generalisation of the notion of a support is a \emph{supporting
  partition}.

\begin{definition}
  Let $G \leq \sym_n$ and $\mathcal{P}$ be a partition of $[n]$. Then
  $\mathcal{P}$ is a \emph{supporting partition} for $G$ if
  $\stab_n(\mathcal{P}) \leq G$.
\end{definition}

Let $\mathcal{P}$ and $\mathcal{P}'$ be supporting partitions for $G$. We say
that $\mathcal{P}'$ is as \emph{coarse} as $\mathcal{P}$, denoted by
$\mathcal{P}' \preceq \mathcal{P}$, if every part in $\mathcal{P}$ is contained
in a part in $\mathcal{P}'$. Anderson and Dawar show that every group $G \leq
\sym_n$ has a unique coarsest supporting partition. We call this partition the
\emph{canonical supporting partition}, and denote it by $\SP (G)$.

It is easy to show that if $\mathcal{P}$ is a supporting partition for $G \leq
\sym_n$ and $P$ is the largest part of $\mathcal{P}$ then $[n] \setminus P$ is a
support for $G$. If $\mathcal{P}$ is the canonical supporting partition for $G$
and $\vert P \vert > \frac{1}{2}$ we call $[n] \setminus P$ the \emph{canonical
  support} for $G$ and denote it by $\consp(G)$.

We apply the language of supports to circuits. Let $C$ be a circuit and $g$ be a
gate in $C$. Let $\orb(g) := \{\pi g : \pi \in \aut(C)\}$ and $\stab_n (g) := \{
\pi \in \aut(C) : \pi g = g \}$. We say that a partition $\mathcal{P}$ of $[n]$
(resp. a set $S \subseteq [n]$) is a supporting partition for $g$ if
$\mathcal{P}$ is a supporting partition for $\stab_n(g)$ (resp. $S$ is a support
for $\stab_n$). We abuse notation and write $\SP(g)$ and $\consp(g)$ for the
cononical supporting partition and canonical support for $g$. Let $\| \SP(g) \|$
denote the smallest value of $[n] \setminus P$ for $P \in \SP(g)$. Let $\SP(C)$
denote the largest value of $\| \SP(g) \|$ for $g$ a gate in $C$. We now state
the support theorem and then discuss its proof.

\begin{theorem}
  \label{thm:support-thm}
  For any $\epsilon$ and $n$ such that $\frac{2}{3} \leq \epsilon \leq 1$ and $n
  \geq \frac{128}{\epsilon^2}$, if $C$ is a symmetric circuit of order $n$ with
  unique labels and $s := \max_{g \in C} \vert \orb (g)\vert \leq
  2^{n^{1-\epsilon}}$, then, $\SP(C) \leq \frac{33}{\epsilon}\frac{\log s}{\log
    n}$.
\end{theorem}

The proof follows a strategy broadly similar to the one used
in~\cite{AndersonD17}, and makes use of two lemmas from there. The first of
these lemmas gives us that if the index of a group $G \leq \sym_n$ is small then
$\SP(G)$ either has very few or very many parts. The second lemma gives us that
for $G \leq \sym_n$, if $\SP(G)$ has very few parts then it must have a single
very large part (and hence a small canonical support). These two results allow
us to conclude that every gate $g$ in $C$ has a small canonical support if it
has a canonical supporting partition with very few parts. We then prove by
structural induction that the canonical supporting partition of every gate has
few parts. To be precise, we show that if $g$ is the topologically first gate in
the circuit with a canonical supporting partition with too many parts, then
$\vert \orb(g) \vert > 2^{n^{1 - \epsilon}}$.

We do this by establishing the existence of a large set $H$ of permutations that
each take $g$ to a different gate. To construct $H$, we define a set of triples
of the form $(\sigma, h, h')$ where $\sigma \in \sym_n$ and $h,h' \in H_g$. Each
of these triples is useful in a sense that it guarantees that $\sigma$ moves
$g$. Moreover, the triples are pairwise independent which means that we can
compose them in arbitrary combinations to generate new permutations moving $g$,
while guaranteeing that each such combination gives us a different element in
the orbit of $g$.

\begin{lemma}
  Let $\mathcal{C} := (C_n)_{n \in \nats}$ be a polynomial-size family of
  symmetric circuits with unique labels. There is a $k$ such that $\SP(C_n) \leq
  k$ for all $n \in \nats$.
  \label{lem:constant-size-support}
\end{lemma}

\subsection{Supports of Indexes}
In our analysis we not only need to consider supports on gates, but also on
elements of the universe of a gate. For a gate $g$ in $C$ with unique extensions
there is an action of $\stab(g)$ on $\universe{g}$ defined $\sigma \cdot a :=
(\pi_{\sigma}\vec{a}_R) (\vec{a}^{-1}_R(a))$, for $\sigma \in \stab(g)$ and $a
\in \universe{g}$, and where $\vec{a}_R \in \ind(g)$ contains the element $a$.
Since $\pi_{\sigma}$ is an automorphism uniquely determined by $\sigma$ this
action is well-defined.

Since we have a group action of $\stab(g)$ on $\universe{g}$, but not $\sym_n$
on $\universe{g}$, we must speak of the support of $a \in \universe{g}$ relative
to $\stab(g)$. We are often interested in the action of the subgroup
$\spstab{g}$ rather. We let $\stab_{\consp{g}}(a)$ and $\orb_{\consp{g}}(a)$ be
the orbit and stabiliser of $a$ under the action of $\spstab{g}$. We let
$\consp_{\consp(g)}(a)$ and $\SP_{\consp(g)}(a)$ denote the canonical support
and canonical supporting partition of $\stab_{\consp(g)}(a)$. The following
lemma is a direct consequence of the support theorem, and it extends it to
elements of the universe of a gate.

\begin{lemma}
  \label{lem:row-column-supports}
  Let $(C_n)_{n \in \nats}$ be a polynomial-size family of symmetric circuits
  with unique labels. There exists $n_0, k \in \nats$ such that for all $n >
  n_0$, $g$ a gate $C_n$ and $a \in \universe{g}$
  \begin{itemize}
  \item $\stab_n(g)$, $\stab_{\consp(g)}(a)$ and $\stab_{g}(a)$ have small
    supports,
  \item if $h \in H_g$ and $a$ appears in $L(g)^{-1}(h)$ then $\consp_g(a)
    \subseteq \consp_{\consp(g)}(a) \subseteq \consp(g) \cup \consp(h)$, and
  \item $\vert \consp(g) \leq k$ and $\vert \consp_g(a) \vert \leq \vert
    \consp_{\consp(g)}(a) \vert \leq 2k$.
  \end{itemize}
\end{lemma}


\section{The Translation from Formulas into Circuits}
The usual translation from formulas to uniform families of symmetric circuits
(see \cite{} for examples) does not result in a family of \emph{transparent}
circuits. We must thus define a novel translation. We first define a translation
from $\PT$-uniform families of bounded-width $\FOrk$-formulas to equivalent
$\PT$-uniform of transparent symmetric rank-circuits. We then define a
translation from formulas of $\FPR$ to $\PT$-uniform families of bounded-width
$\FOrk$-formulas. The first of these translations is given by the following
lemma.

\begin{lemma}
  There is a function that takes as input a $\FOrk$-formula $\theta(\vec{x})$
  and $n \in \nats$ and outputs a circuit $C$ that translates $\theta(\vec{x})$
  for $n$. Moreover, this function is computable and there is a polynomial in
  $p$ such that for an input $(\theta(\vec{x}), n)$ the algorithm computing this
  function terminates in at most $p(n^{\width(\theta)}\vert \cl{\theta} \vert)$
  many steps.
  \label{lem:translating-FOrk}
\end{lemma}

The intuition behind the proof of this result is as follows. For a given $\theta
(\vec{x}) \in \FOrk[\tau]$ we construct a circuit by associating with each
subformula $\psi(\vec{y})$ and $\vec{a}$ an assignment to the free variables in
$\psi$ a gate $g_{\psi, \vec{a}}$ in the circuit. For each assignment $g_{\phi,
  \vec{a}}$ is an input gate of $g_{\psi, \vec{a}}$ if, and only if, $\phi$ is a
direct subformula of $\psi$. However,


\begin{theorem}
  For each $\FPR$-formula $\theta(\vec{x})$ there exists a family of circuits
  $(C_n)_{n \in \nats}$ that translates $\theta(\vec{x})$.
  \label{thm:translating-formulas-to-circuits}
\end{theorem}

\section{The Translation from Circuits into Formulas}

\begin{lemma}
	Let $g$ be a gate in $C_n$. Let $\eta \in U^{\underline{\consp(g)}}$ and
  $\gamma_1, \gamma_2 \in [n]^{\underline{U}}$ such that $\gamma^{-1}_1 \sim
  \eta$ and $\gamma^{-1}_2 \sim \eta$. Then $L^{\gamma_1 \mathcal{A}}(g)$ and
  $L^{\gamma_2 \mathcal{A}}(g)$ are isomorphic.
	\label{lem:support-determines-evaluation}
\end{lemma}

\begin{theorem}
	Let $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim \eta$. Then
  $L^{\gamma}$ is isomorphic to $M_{\equiv}$.
	\label{thm:LM-equivalence}
\end{theorem}

\begin{lemma}
	Let $\gamma \in U^{\underline{n}}$ be such that $\gamma^{-1} \sim \eta$ and
  let $p \in \nats$ be prime. Then $\rank_p (M) = \rank_p (M_\equiv) = \rank_p
  (L^{\gamma})$.
  \label{lem:rank-triple-equivilence}
\end{lemma}


\section{Concluding Remarks and Future Work}

% \appendix

%\bibliography{references.bib}
%\bibliography{lipics-v2018-sample-article}


\end{document}
